/**
 * @fileoverview added by tsickle
 * Generated from: analytics.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { __awaiter } from "tslib";
import { Inject, Injectable, InjectionToken, NgZone, Optional, PLATFORM_ID } from '@angular/core';
import { EMPTY, of } from 'rxjs';
import { isPlatformBrowser } from '@angular/common';
import { map, tap, shareReplay, switchMap, observeOn } from 'rxjs/operators';
import { ɵAngularFireSchedulers, ɵlazySDKProxy, FIREBASE_OPTIONS, FIREBASE_APP_NAME, ɵfirebaseAppFactory } from '@angular/fire';
import * as i0 from "@angular/core";
import * as i1 from "@angular/fire";
/**
 * @record
 */
import * as ɵngcc0 from '@angular/core';
export function Config() { }
/** @type {?} */
export const COLLECTION_ENABLED = new InjectionToken('angularfire2.analytics.analyticsCollectionEnabled');
/** @type {?} */
export const APP_VERSION = new InjectionToken('angularfire2.analytics.appVersion');
/** @type {?} */
export const APP_NAME = new InjectionToken('angularfire2.analytics.appName');
/** @type {?} */
export const DEBUG_MODE = new InjectionToken('angularfire2.analytics.debugMode');
/** @type {?} */
export const CONFIG = new InjectionToken('angularfire2.analytics.config');
/** @type {?} */
const APP_NAME_KEY = 'app_name';
/** @type {?} */
const APP_VERSION_KEY = 'app_version';
/** @type {?} */
const DEBUG_MODE_KEY = 'debug_mode';
/** @type {?} */
const ANALYTICS_ID_FIELD = 'measurementId';
/** @type {?} */
const GTAG_CONFIG_COMMAND = 'config';
/** @type {?} */
const GTAG_FUNCTION_NAME = 'gtag';
/** @type {?} */
const DATA_LAYER_NAME = 'dataLayer';
// WARNING: interface has both a type and a value, skipping emit
/** @type {?} */
let gtag;
/** @type {?} */
let analyticsInitialized;
/** @type {?} */
const analyticsInstanceCache = {};
export class AngularFireAnalytics {
    /**
     * @param {?} options
     * @param {?} nameOrConfig
     * @param {?} analyticsCollectionEnabled
     * @param {?} providedAppVersion
     * @param {?} providedAppName
     * @param {?} debugModeEnabled
     * @param {?} providedConfig
     * @param {?} platformId
     * @param {?} zone
     */
    constructor(options, nameOrConfig, analyticsCollectionEnabled, providedAppVersion, providedAppName, debugModeEnabled, providedConfig, 
    // tslint:disable-next-line:ban-types
    platformId, zone) {
        this.options = options;
        if (!analyticsInitialized) {
            if (isPlatformBrowser(platformId)) {
                window[DATA_LAYER_NAME] = window[DATA_LAYER_NAME] || [];
                // tslint:disable-next-line: only-arrow-functions
                gtag = ((/** @type {?} */ (window[GTAG_FUNCTION_NAME]))) || ((/**
                 * @param {...?} _args
                 * @return {?}
                 */
                function (..._args) {
                    ((/** @type {?} */ (window[DATA_LAYER_NAME]))).push(arguments);
                }));
                analyticsInitialized = zone.runOutsideAngular((/**
                 * @return {?}
                 */
                () => new Promise((/**
                 * @param {?} resolve
                 * @return {?}
                 */
                resolve => {
                    window[GTAG_FUNCTION_NAME] = (/**
                     * @param {...?} args
                     * @return {?}
                     */
                    (...args) => {
                        if (args[0] === 'js') {
                            resolve();
                        }
                        gtag(...args);
                    });
                }))));
            }
            else {
                gtag = (/**
                 * @return {?}
                 */
                () => {
                });
                analyticsInitialized = Promise.resolve();
            }
        }
        /** @type {?} */
        let analytics = analyticsInstanceCache[options[ANALYTICS_ID_FIELD]];
        if (!analytics) {
            analytics = of(undefined).pipe(observeOn(new ɵAngularFireSchedulers(zone).outsideAngular), switchMap((/**
             * @return {?}
             */
            () => isPlatformBrowser(platformId) ? import('firebase/analytics') : EMPTY)), map((/**
             * @return {?}
             */
            () => ɵfirebaseAppFactory(options, zone, nameOrConfig))), map((/**
             * @param {?} app
             * @return {?}
             */
            app => app.analytics())), tap((/**
             * @param {?} analytics
             * @return {?}
             */
            analytics => {
                if (analyticsCollectionEnabled === false) {
                    analytics.setAnalyticsCollectionEnabled(false);
                }
            })), shareReplay({ bufferSize: 1, refCount: false }));
            analyticsInstanceCache[options[ANALYTICS_ID_FIELD]] = analytics;
        }
        if (providedConfig) {
            this.updateConfig(providedConfig);
        }
        if (providedAppName) {
            this.updateConfig({ [APP_NAME_KEY]: providedAppName });
        }
        if (providedAppVersion) {
            this.updateConfig({ [APP_VERSION_KEY]: providedAppVersion });
        }
        if (debugModeEnabled) {
            this.updateConfig({ [DEBUG_MODE_KEY]: 1 });
        }
        return ɵlazySDKProxy(this, analytics, zone);
    }
    /**
     * @param {?} config
     * @return {?}
     */
    updateConfig(config) {
        return __awaiter(this, void 0, void 0, function* () {
            yield analyticsInitialized;
            gtag(GTAG_CONFIG_COMMAND, this.options[ANALYTICS_ID_FIELD], Object.assign(Object.assign({}, config), { update: true }));
        });
    }
}
AngularFireAnalytics.ɵfac = function AngularFireAnalytics_Factory(t) { return new (t || AngularFireAnalytics)(ɵngcc0.ɵɵinject(FIREBASE_OPTIONS), ɵngcc0.ɵɵinject(FIREBASE_APP_NAME, 8), ɵngcc0.ɵɵinject(COLLECTION_ENABLED, 8), ɵngcc0.ɵɵinject(APP_VERSION, 8), ɵngcc0.ɵɵinject(APP_NAME, 8), ɵngcc0.ɵɵinject(DEBUG_MODE, 8), ɵngcc0.ɵɵinject(CONFIG, 8), ɵngcc0.ɵɵinject(PLATFORM_ID), ɵngcc0.ɵɵinject(ɵngcc0.NgZone)); };
/** @nocollapse */
AngularFireAnalytics.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [FIREBASE_OPTIONS,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [FIREBASE_APP_NAME,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [COLLECTION_ENABLED,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [APP_VERSION,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [APP_NAME,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [DEBUG_MODE,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [CONFIG,] }] },
    { type: Object, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] },
    { type: NgZone }
];
/** @nocollapse */ AngularFireAnalytics.ɵprov = i0.ɵɵdefineInjectable({ factory: function AngularFireAnalytics_Factory() { return new AngularFireAnalytics(i0.ɵɵinject(i1.FIREBASE_OPTIONS), i0.ɵɵinject(i1.FIREBASE_APP_NAME, 8), i0.ɵɵinject(COLLECTION_ENABLED, 8), i0.ɵɵinject(APP_VERSION, 8), i0.ɵɵinject(APP_NAME, 8), i0.ɵɵinject(DEBUG_MODE, 8), i0.ɵɵinject(CONFIG, 8), i0.ɵɵinject(i0.PLATFORM_ID), i0.ɵɵinject(i0.NgZone)); }, token: AngularFireAnalytics, providedIn: "any" });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(AngularFireAnalytics, [{
        type: Injectable,
        args: [{
                providedIn: 'any'
            }]
    }], function () { return [{ type: undefined, decorators: [{
                type: Inject,
                args: [FIREBASE_OPTIONS]
            }] }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [FIREBASE_APP_NAME]
            }] }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [COLLECTION_ENABLED]
            }] }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [APP_VERSION]
            }] }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [APP_NAME]
            }] }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [DEBUG_MODE]
            }] }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [CONFIG]
            }] }, { type: Object, decorators: [{
                type: Inject,
                args: [PLATFORM_ID]
            }] }, { type: ɵngcc0.NgZone }]; }, null); })();
if (false) {
    /**
     * @type {?}
     * @private
     */
    AngularFireAnalytics.prototype.options;
}

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5hbHl0aWNzLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvYW5hbHl0aWNzL2FuYWx5dGljcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxjQUFjLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbEcsT0FBTyxFQUFFLEtBQUssRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDN0MsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDcEQsT0FBTyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM3RSxPQUFPLEVBR0wsc0JBQXNCLEVBQ3RCLGFBQWEsRUFDYixnQkFBZ0IsRUFDaEIsaUJBQWlCLEVBQ2pCLG1CQUFtQixFQUVwQixNQUFNLGVBQWUsQ0FBQztBQUN2QjtBQUFxQztBQUNMO0FBQUk7QUFFM0I7O0FBQVQsNEJBRUM7QUFDRDtBQUNBLE1BQU0sT0FBTyxrQkFBa0IsR0FBRyxJQUFJLGNBQWMsQ0FBVSxtREFBbUQsQ0FBQztBQUNsSDtBQUFBLE1BQU0sT0FBTyxXQUFXLEdBQUcsSUFBSSxjQUFjLENBQVMsbUNBQW1DLENBQUM7QUFDMUY7QUFBQSxNQUFNLE9BQU8sUUFBUSxHQUFHLElBQUksY0FBYyxDQUFTLGdDQUFnQyxDQUFDO0FBQ3BGO0FBQUEsTUFBTSxPQUFPLFVBQVUsR0FBRyxJQUFJLGNBQWMsQ0FBVSxrQ0FBa0MsQ0FBQztBQUN6RjtBQUFBLE1BQU0sT0FBTyxNQUFNLEdBQUcsSUFBSSxjQUFjLENBQVMsK0JBQStCLENBQUM7QUFDakY7QUFDZ0IsTUFBVixZQUFZLEdBQUcsVUFBVTtBQUMvQjtBQUFpQixNQUFYLGVBQWUsR0FBRyxhQUFhO0FBQ3JDO0FBQWlCLE1BQVgsY0FBYyxHQUFHLFlBQVk7QUFDbkM7QUFBaUIsTUFBWCxrQkFBa0IsR0FBRyxlQUFlO0FBQzFDO0FBQWlCLE1BQVgsbUJBQW1CLEdBQUcsUUFBUTtBQUNwQztBQUFpQixNQUFYLGtCQUFrQixHQUFHLE1BQU07QUFDakM7QUFBaUIsTUFBWCxlQUFlLEdBQUcsV0FBVztBQUNuQztBQUNnRTtBQUFpQixJQUc3RSxJQUE4QjtBQUNsQztBQUFpQixJQUFiLG9CQUFtQztBQUN2QztBQUFpQixNQUFYLHNCQUFzQixHQUF1RCxFQUFFO0FBS3JGLE1BQU0sT0FBTyxvQkFBb0I7QUFDakM7QUFDTztBQUEwQjtBQUNSO0FBQ2E7QUFBcUM7QUFHakU7QUFDb0I7QUFBaUM7QUFDbkM7QUFBdUI7QUFBUSxJQUZ6RCxZQUNvQyxPQUF3QixFQUNuQixZQUEyRCxFQUMxRCwwQkFBMEMsRUFDakQsa0JBQWlDLEVBQ3BDLGVBQThCLEVBQzVCLGdCQUFnQyxFQUNwQyxjQUE2QjtBQUM1RCxJQUFHLHFDQUFxQztBQUN6QyxJQUF5QixVQUFrQixFQUN2QyxJQUFZO0FBQ2IsUUFWbUMsWUFBTyxHQUFQLE9BQU8sQ0FBaUI7QUFBQyxRQVkzRCxJQUFJLENBQUMsb0JBQW9CLEVBQUU7QUFDL0IsWUFBTSxJQUFJLGlCQUFpQixDQUFDLFVBQVUsQ0FBQyxFQUFFO0FBQ3pDLGdCQUFRLE1BQU0sQ0FBQyxlQUFlLENBQUMsR0FBRyxNQUFNLENBQUMsZUFBZSxDQUFDLElBQUksRUFBRSxDQUFDO0FBQ2hFLGdCQUFRLGlEQUFpRDtBQUN6RCxnQkFBUSxJQUFJLEdBQUcsQ0FBQyxtQkFBQSxNQUFNLENBQUMsa0JBQWtCLENBQUMsRUFBTyxDQUFDLElBQUk7QUFBTTtBQUM1QztBQUErQjtBQUN4QyxnQkFGZ0QsVUFBUyxHQUFHLEtBQVk7QUFDL0Usb0JBQVUsQ0FBQyxtQkFBQSxNQUFNLENBQUMsZUFBZSxDQUFDLEVBQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUMzRCxnQkFBUSxDQUFDLEVBQUMsQ0FBQztBQUNYLGdCQUFRLG9CQUFvQixHQUFHLElBQUksQ0FBQyxpQkFBaUI7QUFBTTtBQUM3QjtBQUNmLGdCQUZ1QyxHQUFHLEVBQUUsQ0FDakQsSUFBSSxPQUFPO0FBQU07QUFDRztBQUErQjtBQUMzQyxnQkFGSSxPQUFPLENBQUMsRUFBRTtBQUNoQyxvQkFBWSxNQUFNLENBQUMsa0JBQWtCLENBQUM7QUFBUTtBQUNyQjtBQUNIO0FBRW5CLG9CQUpzQyxDQUFDLEdBQUcsSUFBVyxFQUFFLEVBQUU7QUFDNUQsd0JBQWMsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssSUFBSSxFQUFFO0FBQ3BDLDRCQUFnQixPQUFPLEVBQUUsQ0FBQztBQUMxQix5QkFBZTtBQUNmLHdCQUFjLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDO0FBQzVCLG9CQUFZLENBQUMsQ0FBQSxDQUFDO0FBQ2QsZ0JBQVUsQ0FBQyxFQUFDLEVBQ0gsQ0FBQztBQUNWLGFBQU87QUFBQyxpQkFBSztBQUNiLGdCQUFRLElBQUk7QUFBUTtBQUVIO0FBQW9CLGdCQUZ0QixHQUFHLEVBQUU7QUFDcEIsZ0JBQVEsQ0FBQyxDQUFBLENBQUM7QUFDVixnQkFBUSxvQkFBb0IsR0FBRyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDakQsYUFBTztBQUNQLFNBQUs7QUFDTDtBQUN3QixZQUFoQixTQUFTLEdBQUcsc0JBQXNCLENBQUMsT0FBTyxDQUFDLGtCQUFrQixDQUFDLENBQUM7QUFDdkUsUUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFO0FBQ3BCLFlBQU0sU0FBUyxHQUFHLEVBQUUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQzVCLFNBQVMsQ0FBQyxJQUFJLHNCQUFzQixDQUFDLElBQUksQ0FBQyxDQUFDLGNBQWMsQ0FBQyxFQUMxRCxTQUFTO0FBQU07QUFBMkI7QUFBZ0IsWUFBaEQsR0FBRyxFQUFFLENBQUMsaUJBQWlCLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUMsRUFDckYsR0FBRztBQUFNO0FBQTJCO0FBQWdCLFlBQWhELEdBQUcsRUFBRSxDQUFDLG1CQUFtQixDQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsWUFBWSxDQUFDLEVBQUMsRUFDM0QsR0FBRztBQUFNO0FBQ1A7QUFDQTtBQUFnQixZQUZkLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxFQUFDLEVBQzNCLEdBQUc7QUFBTTtBQUNTO0FBQTJCO0FBQ3RDLFlBRkgsU0FBUyxDQUFDLEVBQUU7QUFDeEIsZ0JBQVUsSUFBSSwwQkFBMEIsS0FBSyxLQUFLLEVBQUU7QUFDcEQsb0JBQVksU0FBUyxDQUFDLDZCQUE2QixDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQzNELGlCQUFXO0FBQ1gsWUFBUSxDQUFDLEVBQUMsRUFDRixXQUFXLENBQUMsRUFBRSxVQUFVLEVBQUUsQ0FBQyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUNoRCxDQUFDO0FBQ1IsWUFBTSxzQkFBc0IsQ0FBQyxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxHQUFHLFNBQVMsQ0FBQztBQUN0RSxTQUFLO0FBQ0wsUUFDSSxJQUFJLGNBQWMsRUFBRTtBQUN4QixZQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsY0FBYyxDQUFDLENBQUM7QUFDeEMsU0FBSztBQUNMLFFBQUksSUFBSSxlQUFlLEVBQUU7QUFDekIsWUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxZQUFZLENBQUMsRUFBRSxlQUFlLEVBQUUsQ0FBQyxDQUFDO0FBQzdELFNBQUs7QUFDTCxRQUFJLElBQUksa0JBQWtCLEVBQUU7QUFDNUIsWUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxlQUFlLENBQUMsRUFBRSxrQkFBa0IsRUFBRSxDQUFDLENBQUM7QUFDbkUsU0FBSztBQUNMLFFBQUksSUFBSSxnQkFBZ0IsRUFBRTtBQUMxQixZQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDLGNBQWMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDakQsU0FBSztBQUNMLFFBQ0ksT0FBTyxhQUFhLENBQUMsSUFBSSxFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsQ0FBQztBQUNoRCxJQUNFLENBQUM7QUFDSDtBQUVLO0FBQXlCO0FBQW1CO0FBQVEsSUE3RWpELFlBQVksQ0FBQyxNQUFjO0FBQ25DO0FBQzhCLFlBRDFCLE1BQU0sb0JBQW9CLENBQUM7QUFDL0IsWUFBSSxJQUFJLENBQUMsbUJBQW1CLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxrQ0FBTyxNQUFNLEtBQUUsTUFBTSxFQUFFLElBQUksSUFBRyxDQUFDO0FBQzdGLFFBQUUsQ0FBQztBQUVGLEtBRkU7QUFDSDtnREFUQyxVQUFVLFNBQUMsa0JBQ1YsVUFBVSxFQUFFLEtBQUssY0FDbEIsd1NBQ0k7QUFBQztBQUFtQjtBQUVTLDRDQU03QixNQUFNLFNBQUMsZ0JBQWdCO0FBQVMsNENBQ2hDLFFBQVEsWUFBSSxNQUFNLFNBQUMsaUJBQWlCO0FBQVMsNENBQzdDLFFBQVEsWUFBSSxNQUFNLFNBQUMsa0JBQWtCO0FBQVMsNENBQzlDLFFBQVEsWUFBSSxNQUFNLFNBQUMsV0FBVztBQUFTLDRDQUN2QyxRQUFRLFlBQUksTUFBTSxTQUFDLFFBQVE7QUFBUyw0Q0FDcEMsUUFBUSxZQUFJLE1BQU0sU0FBQyxVQUFVO0FBQVMsNENBQ3RDLFFBQVEsWUFBSSxNQUFNLFNBQUMsTUFBTTtBQUFTLFlBRUYsTUFBTSx1QkFBdEMsTUFBTSxTQUFDLFdBQVc7QUFBUyxZQTdEYSxNQUFNO0FBQUc7QUFBRzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OzJEQWVyQztBQUFDO0FBQWE7QUFFOUI7QUFBaUI7QUFDVjtBQUFRLElBbUNmLHVDQUEwRDtBQUFDO0FBQzlEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBJbmplY3Rpb25Ub2tlbiwgTmdab25lLCBPcHRpb25hbCwgUExBVEZPUk1fSUQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEVNUFRZLCBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgaXNQbGF0Zm9ybUJyb3dzZXIgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgbWFwLCB0YXAsIHNoYXJlUmVwbGF5LCBzd2l0Y2hNYXAsIG9ic2VydmVPbiB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7XG4gIEZpcmViYXNlQXBwQ29uZmlnLFxuICBGaXJlYmFzZU9wdGlvbnMsXG4gIMm1QW5ndWxhckZpcmVTY2hlZHVsZXJzLFxuICDJtWxhenlTREtQcm94eSxcbiAgRklSRUJBU0VfT1BUSU9OUyxcbiAgRklSRUJBU0VfQVBQX05BTUUsXG4gIMm1ZmlyZWJhc2VBcHBGYWN0b3J5LFxuICDJtVByb21pc2VQcm94eVxufSBmcm9tICdAYW5ndWxhci9maXJlJztcbmltcG9ydCB7IGFuYWx5dGljcyB9IGZyb20gJ2ZpcmViYXNlL2FwcCc7XG5pbXBvcnQgZmlyZWJhc2UgZnJvbSAnZmlyZWJhc2UvYXBwJztcblxuZXhwb3J0IGludGVyZmFjZSBDb25maWcge1xuICBba2V5OiBzdHJpbmddOiBhbnk7XG59XG5cbmV4cG9ydCBjb25zdCBDT0xMRUNUSU9OX0VOQUJMRUQgPSBuZXcgSW5qZWN0aW9uVG9rZW48Ym9vbGVhbj4oJ2FuZ3VsYXJmaXJlMi5hbmFseXRpY3MuYW5hbHl0aWNzQ29sbGVjdGlvbkVuYWJsZWQnKTtcbmV4cG9ydCBjb25zdCBBUFBfVkVSU0lPTiA9IG5ldyBJbmplY3Rpb25Ub2tlbjxzdHJpbmc+KCdhbmd1bGFyZmlyZTIuYW5hbHl0aWNzLmFwcFZlcnNpb24nKTtcbmV4cG9ydCBjb25zdCBBUFBfTkFNRSA9IG5ldyBJbmplY3Rpb25Ub2tlbjxzdHJpbmc+KCdhbmd1bGFyZmlyZTIuYW5hbHl0aWNzLmFwcE5hbWUnKTtcbmV4cG9ydCBjb25zdCBERUJVR19NT0RFID0gbmV3IEluamVjdGlvblRva2VuPGJvb2xlYW4+KCdhbmd1bGFyZmlyZTIuYW5hbHl0aWNzLmRlYnVnTW9kZScpO1xuZXhwb3J0IGNvbnN0IENPTkZJRyA9IG5ldyBJbmplY3Rpb25Ub2tlbjxDb25maWc+KCdhbmd1bGFyZmlyZTIuYW5hbHl0aWNzLmNvbmZpZycpO1xuXG5jb25zdCBBUFBfTkFNRV9LRVkgPSAnYXBwX25hbWUnO1xuY29uc3QgQVBQX1ZFUlNJT05fS0VZID0gJ2FwcF92ZXJzaW9uJztcbmNvbnN0IERFQlVHX01PREVfS0VZID0gJ2RlYnVnX21vZGUnO1xuY29uc3QgQU5BTFlUSUNTX0lEX0ZJRUxEID0gJ21lYXN1cmVtZW50SWQnO1xuY29uc3QgR1RBR19DT05GSUdfQ09NTUFORCA9ICdjb25maWcnO1xuY29uc3QgR1RBR19GVU5DVElPTl9OQU1FID0gJ2d0YWcnO1xuY29uc3QgREFUQV9MQVlFUl9OQU1FID0gJ2RhdGFMYXllcic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQW5ndWxhckZpcmVBbmFseXRpY3MgZXh0ZW5kcyDJtVByb21pc2VQcm94eTxhbmFseXRpY3MuQW5hbHl0aWNzPiB7XG59XG5cbmxldCBndGFnOiAoLi4uYXJnczogYW55W10pID0+IHZvaWQ7XG5sZXQgYW5hbHl0aWNzSW5pdGlhbGl6ZWQ6IFByb21pc2U8dm9pZD47XG5jb25zdCBhbmFseXRpY3NJbnN0YW5jZUNhY2hlOiB7IFtrZXk6IHN0cmluZ106IE9ic2VydmFibGU8YW5hbHl0aWNzLkFuYWx5dGljcz4gfSA9IHt9O1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdhbnknXG59KVxuZXhwb3J0IGNsYXNzIEFuZ3VsYXJGaXJlQW5hbHl0aWNzIHtcblxuICBhc3luYyB1cGRhdGVDb25maWcoY29uZmlnOiBDb25maWcpIHtcbiAgICBhd2FpdCBhbmFseXRpY3NJbml0aWFsaXplZDtcbiAgICBndGFnKEdUQUdfQ09ORklHX0NPTU1BTkQsIHRoaXMub3B0aW9uc1tBTkFMWVRJQ1NfSURfRklFTERdLCB7IC4uLmNvbmZpZywgdXBkYXRlOiB0cnVlIH0pO1xuICB9XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQEluamVjdChGSVJFQkFTRV9PUFRJT05TKSBwcml2YXRlIG9wdGlvbnM6IEZpcmViYXNlT3B0aW9ucyxcbiAgICBAT3B0aW9uYWwoKSBASW5qZWN0KEZJUkVCQVNFX0FQUF9OQU1FKSBuYW1lT3JDb25maWc6IHN0cmluZyB8IEZpcmViYXNlQXBwQ29uZmlnIHwgbnVsbCB8IHVuZGVmaW5lZCxcbiAgICBAT3B0aW9uYWwoKSBASW5qZWN0KENPTExFQ1RJT05fRU5BQkxFRCkgYW5hbHl0aWNzQ29sbGVjdGlvbkVuYWJsZWQ6IGJvb2xlYW4gfCBudWxsLFxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoQVBQX1ZFUlNJT04pIHByb3ZpZGVkQXBwVmVyc2lvbjogc3RyaW5nIHwgbnVsbCxcbiAgICBAT3B0aW9uYWwoKSBASW5qZWN0KEFQUF9OQU1FKSBwcm92aWRlZEFwcE5hbWU6IHN0cmluZyB8IG51bGwsXG4gICAgQE9wdGlvbmFsKCkgQEluamVjdChERUJVR19NT0RFKSBkZWJ1Z01vZGVFbmFibGVkOiBib29sZWFuIHwgbnVsbCxcbiAgICBAT3B0aW9uYWwoKSBASW5qZWN0KENPTkZJRykgcHJvdmlkZWRDb25maWc6IENvbmZpZyB8IG51bGwsXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOmJhbi10eXBlc1xuICAgIEBJbmplY3QoUExBVEZPUk1fSUQpIHBsYXRmb3JtSWQ6IE9iamVjdCxcbiAgICB6b25lOiBOZ1pvbmVcbiAgKSB7XG5cbiAgICBpZiAoIWFuYWx5dGljc0luaXRpYWxpemVkKSB7XG4gICAgICBpZiAoaXNQbGF0Zm9ybUJyb3dzZXIocGxhdGZvcm1JZCkpIHtcbiAgICAgICAgd2luZG93W0RBVEFfTEFZRVJfTkFNRV0gPSB3aW5kb3dbREFUQV9MQVlFUl9OQU1FXSB8fCBbXTtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBvbmx5LWFycm93LWZ1bmN0aW9uc1xuICAgICAgICBndGFnID0gKHdpbmRvd1tHVEFHX0ZVTkNUSU9OX05BTUVdIGFzIGFueSkgfHwgKGZ1bmN0aW9uKC4uLl9hcmdzOiBhbnlbXSkge1xuICAgICAgICAgICh3aW5kb3dbREFUQV9MQVlFUl9OQU1FXSBhcyBhbnkpLnB1c2goYXJndW1lbnRzKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGFuYWx5dGljc0luaXRpYWxpemVkID0gem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PlxuICAgICAgICAgIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgICAgICAgd2luZG93W0dUQUdfRlVOQ1RJT05fTkFNRV0gPSAoLi4uYXJnczogYW55W10pID0+IHtcbiAgICAgICAgICAgICAgaWYgKGFyZ3NbMF0gPT09ICdqcycpIHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgZ3RhZyguLi5hcmdzKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGd0YWcgPSAoKSA9PiB7XG4gICAgICAgIH07XG4gICAgICAgIGFuYWx5dGljc0luaXRpYWxpemVkID0gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgbGV0IGFuYWx5dGljcyA9IGFuYWx5dGljc0luc3RhbmNlQ2FjaGVbb3B0aW9uc1tBTkFMWVRJQ1NfSURfRklFTERdXTtcbiAgICBpZiAoIWFuYWx5dGljcykge1xuICAgICAgYW5hbHl0aWNzID0gb2YodW5kZWZpbmVkKS5waXBlKFxuICAgICAgICBvYnNlcnZlT24obmV3IMm1QW5ndWxhckZpcmVTY2hlZHVsZXJzKHpvbmUpLm91dHNpZGVBbmd1bGFyKSxcbiAgICAgICAgc3dpdGNoTWFwKCgpID0+IGlzUGxhdGZvcm1Ccm93c2VyKHBsYXRmb3JtSWQpID8gaW1wb3J0KCdmaXJlYmFzZS9hbmFseXRpY3MnKSA6IEVNUFRZKSxcbiAgICAgICAgbWFwKCgpID0+IMm1ZmlyZWJhc2VBcHBGYWN0b3J5KG9wdGlvbnMsIHpvbmUsIG5hbWVPckNvbmZpZykpLFxuICAgICAgICBtYXAoYXBwID0+IGFwcC5hbmFseXRpY3MoKSksXG4gICAgICAgIHRhcChhbmFseXRpY3MgPT4ge1xuICAgICAgICAgIGlmIChhbmFseXRpY3NDb2xsZWN0aW9uRW5hYmxlZCA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgIGFuYWx5dGljcy5zZXRBbmFseXRpY3NDb2xsZWN0aW9uRW5hYmxlZChmYWxzZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KSxcbiAgICAgICAgc2hhcmVSZXBsYXkoeyBidWZmZXJTaXplOiAxLCByZWZDb3VudDogZmFsc2UgfSlcbiAgICAgICk7XG4gICAgICBhbmFseXRpY3NJbnN0YW5jZUNhY2hlW29wdGlvbnNbQU5BTFlUSUNTX0lEX0ZJRUxEXV0gPSBhbmFseXRpY3M7XG4gICAgfVxuXG4gICAgaWYgKHByb3ZpZGVkQ29uZmlnKSB7XG4gICAgICB0aGlzLnVwZGF0ZUNvbmZpZyhwcm92aWRlZENvbmZpZyk7XG4gICAgfVxuICAgIGlmIChwcm92aWRlZEFwcE5hbWUpIHtcbiAgICAgIHRoaXMudXBkYXRlQ29uZmlnKHsgW0FQUF9OQU1FX0tFWV06IHByb3ZpZGVkQXBwTmFtZSB9KTtcbiAgICB9XG4gICAgaWYgKHByb3ZpZGVkQXBwVmVyc2lvbikge1xuICAgICAgdGhpcy51cGRhdGVDb25maWcoeyBbQVBQX1ZFUlNJT05fS0VZXTogcHJvdmlkZWRBcHBWZXJzaW9uIH0pO1xuICAgIH1cbiAgICBpZiAoZGVidWdNb2RlRW5hYmxlZCkge1xuICAgICAgdGhpcy51cGRhdGVDb25maWcoeyBbREVCVUdfTU9ERV9LRVldOiAxIH0pO1xuICAgIH1cblxuICAgIHJldHVybiDJtWxhenlTREtQcm94eSh0aGlzLCBhbmFseXRpY3MsIHpvbmUpO1xuXG4gIH1cblxufVxuIl19