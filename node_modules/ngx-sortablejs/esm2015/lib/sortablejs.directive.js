/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, ElementRef, EventEmitter, Inject, Input, NgZone, Optional, Output, Renderer2 } from '@angular/core';
import Sortable from 'sortablejs';
import { GLOBALS } from './globals';
import { SortablejsBindings } from './sortablejs-bindings';
import { SortablejsService } from './sortablejs.service';
/** @type {?} */
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './sortablejs.service';
const getIndexesFromEvent = (/**
 * @param {?} event
 * @return {?}
 */
(event) => {
    if (event.hasOwnProperty('newDraggableIndex') && event.hasOwnProperty('oldDraggableIndex')) {
        return {
            new: event.newDraggableIndex,
            old: event.oldDraggableIndex,
        };
    }
    else {
        return {
            new: event.newIndex,
            old: event.oldIndex,
        };
    }
});
const ɵ0 = getIndexesFromEvent;
export class SortablejsDirective {
    /**
     * @param {?} globalConfig
     * @param {?} service
     * @param {?} element
     * @param {?} zone
     * @param {?} renderer
     */
    constructor(globalConfig, service, element, zone, renderer) {
        this.globalConfig = globalConfig;
        this.service = service;
        this.element = element;
        this.zone = zone;
        this.renderer = renderer;
        this.runInsideAngular = false; // to be deprecated
        // to be deprecated
        this.sortablejsInit = new EventEmitter();
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        if (Sortable && Sortable.create) { // Sortable does not exist in angular universal (SSR)
            if (this.runInsideAngular) {
                this.create();
            }
            else {
                this.zone.runOutsideAngular((/**
                 * @return {?}
                 */
                () => this.create()));
            }
        }
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        /** @type {?} */
        const optionsChange = changes.sortablejsOptions;
        if (optionsChange && !optionsChange.isFirstChange()) {
            /** @type {?} */
            const previousOptions = optionsChange.previousValue;
            /** @type {?} */
            const currentOptions = optionsChange.currentValue;
            Object.keys(currentOptions).forEach((/**
             * @param {?} optionName
             * @return {?}
             */
            optionName => {
                if (currentOptions[optionName] !== previousOptions[optionName]) {
                    // use low-level option setter
                    this.sortableInstance.option(optionName, this.options[optionName]);
                }
            }));
        }
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        if (this.sortableInstance) {
            this.sortableInstance.destroy();
        }
    }
    /**
     * @private
     * @return {?}
     */
    create() {
        /** @type {?} */
        const container = this.sortablejsContainer ? this.element.nativeElement.querySelector(this.sortablejsContainer) : this.element.nativeElement;
        setTimeout((/**
         * @return {?}
         */
        () => {
            this.sortableInstance = Sortable.create(container, this.options);
            this.sortablejsInit.emit(this.sortableInstance);
        }), 0);
    }
    /**
     * @private
     * @return {?}
     */
    getBindings() {
        if (!this.sortablejs) {
            return new SortablejsBindings([]);
        }
        else if (this.sortablejs instanceof SortablejsBindings) {
            return this.sortablejs;
        }
        else {
            return new SortablejsBindings([this.sortablejs]);
        }
    }
    /**
     * @private
     * @return {?}
     */
    get options() {
        return Object.assign({}, this.optionsWithoutEvents, this.overridenOptions);
    }
    /**
     * @private
     * @return {?}
     */
    get optionsWithoutEvents() {
        return Object.assign({}, (this.globalConfig || {}), (this.sortablejsOptions || {}));
    }
    /**
     * @private
     * @param {?} eventName
     * @param {...?} params
     * @return {?}
     */
    proxyEvent(eventName, ...params) {
        this.zone.run((/**
         * @return {?}
         */
        () => {
            if (this.optionsWithoutEvents && this.optionsWithoutEvents[eventName]) {
                this.optionsWithoutEvents[eventName](...params);
            }
        }));
    }
    /**
     * @private
     * @return {?}
     */
    get isCloning() {
        return this.sortableInstance.options.group.checkPull(this.sortableInstance, this.sortableInstance) === 'clone';
    }
    /**
     * @private
     * @template T
     * @param {?} item
     * @return {?}
     */
    clone(item) {
        // by default pass the item through, no cloning performed
        return (this.sortablejsCloneFunction || ((/**
         * @param {?} subitem
         * @return {?}
         */
        subitem => subitem)))(item);
    }
    /**
     * @private
     * @return {?}
     */
    get overridenOptions() {
        // always intercept standard events but act only in case items are set (bindingEnabled)
        // allows to forget about tracking this.items changes
        return {
            onAdd: (/**
             * @param {?} event
             * @return {?}
             */
            (event) => {
                this.service.transfer = (/**
                 * @param {?} items
                 * @return {?}
                 */
                (items) => {
                    this.getBindings().injectIntoEvery(event.newIndex, items);
                    this.proxyEvent('onAdd', event);
                });
                this.proxyEvent('onAddOriginal', event);
            }),
            onRemove: (/**
             * @param {?} event
             * @return {?}
             */
            (event) => {
                /** @type {?} */
                const bindings = this.getBindings();
                if (bindings.provided) {
                    if (this.isCloning) {
                        this.service.transfer(bindings.getFromEvery(event.oldIndex).map((/**
                         * @param {?} item
                         * @return {?}
                         */
                        item => this.clone(item))));
                        // great thanks to https://github.com/tauu
                        // event.item is the original item from the source list which is moved to the target list
                        // event.clone is a clone of the original item and will be added to source list
                        // If bindings are provided, adding the item dom element to the target list causes artifacts
                        // as it interferes with the rendering performed by the angular template.
                        // Therefore we remove it immediately and also move the original item back to the source list.
                        // (event handler may be attached to the original item and not its clone, therefore keeping
                        // the original dom node, circumvents side effects )
                        this.renderer.removeChild(event.item.parentNode, event.item);
                        this.renderer.insertBefore(event.clone.parentNode, event.item, event.clone);
                        this.renderer.removeChild(event.clone.parentNode, event.clone);
                    }
                    else {
                        this.service.transfer(bindings.extractFromEvery(event.oldIndex));
                    }
                    this.service.transfer = null;
                }
                this.proxyEvent('onRemove', event);
            }),
            onUpdate: (/**
             * @param {?} event
             * @return {?}
             */
            (event) => {
                /** @type {?} */
                const bindings = this.getBindings();
                /** @type {?} */
                const indexes = getIndexesFromEvent(event);
                bindings.injectIntoEvery(indexes.new, bindings.extractFromEvery(indexes.old));
                this.proxyEvent('onUpdate', event);
            }),
        };
    }
}
SortablejsDirective.ɵfac = function SortablejsDirective_Factory(t) { return new (t || SortablejsDirective)(ɵngcc0.ɵɵdirectiveInject(GLOBALS, 8), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.SortablejsService), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ElementRef), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.NgZone), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.Renderer2)); };
SortablejsDirective.ɵdir = ɵngcc0.ɵɵdefineDirective({ type: SortablejsDirective, selectors: [["", "sortablejs", ""]], inputs: { runInsideAngular: "runInsideAngular", sortablejs: "sortablejs", sortablejsContainer: "sortablejsContainer", sortablejsOptions: "sortablejsOptions", sortablejsCloneFunction: "sortablejsCloneFunction" }, outputs: { sortablejsInit: "sortablejsInit" }, features: [ɵngcc0.ɵɵNgOnChangesFeature] });
/** @nocollapse */
SortablejsDirective.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [GLOBALS,] }] },
    { type: SortablejsService },
    { type: ElementRef },
    { type: NgZone },
    { type: Renderer2 }
];
SortablejsDirective.propDecorators = {
    sortablejs: [{ type: Input }],
    sortablejsContainer: [{ type: Input }],
    sortablejsOptions: [{ type: Input }],
    sortablejsCloneFunction: [{ type: Input }],
    runInsideAngular: [{ type: Input }],
    sortablejsInit: [{ type: Output }]
};
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(SortablejsDirective, [{
        type: Directive,
        args: [{
                selector: '[sortablejs]'
            }]
    }], function () { return [{ type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [GLOBALS]
            }] }, { type: ɵngcc1.SortablejsService }, { type: ɵngcc0.ElementRef }, { type: ɵngcc0.NgZone }, { type: ɵngcc0.Renderer2 }]; }, { runInsideAngular: [{
            type: Input
        }], sortablejsInit: [{
            type: Output
        }], sortablejs: [{
            type: Input
        }], sortablejsContainer: [{
            type: Input
        }], sortablejsOptions: [{
            type: Input
        }], sortablejsCloneFunction: [{
            type: Input
        }] }); })();
if (false) {
    /** @type {?} */
    SortablejsDirective.prototype.sortablejs;
    /** @type {?} */
    SortablejsDirective.prototype.sortablejsContainer;
    /** @type {?} */
    SortablejsDirective.prototype.sortablejsOptions;
    /** @type {?} */
    SortablejsDirective.prototype.sortablejsCloneFunction;
    /**
     * @type {?}
     * @private
     */
    SortablejsDirective.prototype.sortableInstance;
    /** @type {?} */
    SortablejsDirective.prototype.runInsideAngular;
    /** @type {?} */
    SortablejsDirective.prototype.sortablejsInit;
    /**
     * @type {?}
     * @private
     */
    SortablejsDirective.prototype.globalConfig;
    /**
     * @type {?}
     * @private
     */
    SortablejsDirective.prototype.service;
    /**
     * @type {?}
     * @private
     */
    SortablejsDirective.prototype.element;
    /**
     * @type {?}
     * @private
     */
    SortablejsDirective.prototype.zone;
    /**
     * @type {?}
     * @private
     */
    SortablejsDirective.prototype.renderer;
}
/**
 * @record
 */
function SortableEvent() { }
if (false) {
    /** @type {?} */
    SortableEvent.prototype.oldIndex;
    /** @type {?} */
    SortableEvent.prototype.newIndex;
    /** @type {?|undefined} */
    SortableEvent.prototype.oldDraggableIndex;
    /** @type {?|undefined} */
    SortableEvent.prototype.newDraggableIndex;
    /** @type {?} */
    SortableEvent.prototype.item;
    /** @type {?} */
    SortableEvent.prototype.clone;
}
export { ɵ0 };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29ydGFibGVqcy5kaXJlY3RpdmUuanMiLCJzb3VyY2VzIjpbIm5neC1zb3J0YWJsZWpzL2xpYi9zb3J0YWJsZWpzLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFnQyxRQUFRLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBZ0IsTUFBTSxlQUFlLENBQUM7QUFDcEssT0FBTyxRQUFRLE1BQU0sWUFBWSxDQUFDO0FBQ2xDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFFcEMsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFFM0QsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDekQ7OztBQUNnQixNQUFWLG1CQUFtQjtBQUFRO0FBQW9CO0FBQ3pDO0FBRGdCLENBQUMsS0FBb0IsRUFBRSxFQUFFO0FBQ3JELElBQUUsSUFBSSxLQUFLLENBQUMsY0FBYyxDQUFDLG1CQUFtQixDQUFDLElBQUksS0FBSyxDQUFDLGNBQWMsQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFO0FBQzlGLFFBQU0sT0FBTztBQUNiLFlBQVEsR0FBRyxFQUFFLEtBQUssQ0FBQyxpQkFBaUI7QUFDcEMsWUFBUSxHQUFHLEVBQUUsS0FBSyxDQUFDLGlCQUFpQjtBQUNwQyxTQUFPLENBQUM7QUFDUixLQUFHO0FBQUMsU0FBSztBQUNULFFBQUksT0FBTztBQUNYLFlBQU0sR0FBRyxFQUFFLEtBQUssQ0FBQyxRQUFRO0FBQ3pCLFlBQU0sR0FBRyxFQUFFLEtBQUssQ0FBQyxRQUFRO0FBQ3pCLFNBQUssQ0FBQztBQUNOLEtBQUc7QUFDSCxDQUFDLENBQUE7QUFDRDtBQUlBLE1BQU0sT0FBTyxtQkFBbUI7QUFBRztBQUFRO0FBQStCO0FBRzdEO0FBQTBCO0FBQXVCO0FBR2hEO0FBQVEsSUFjcEIsWUFDdUMsWUFBK0IsRUFDNUQsT0FBMEIsRUFDMUIsT0FBbUIsRUFDbkIsSUFBWSxFQUNaLFFBQW1CO0FBQzdCLFFBTHVDLGlCQUFZLEdBQVosWUFBWSxDQUFtQjtBQUFDLFFBQzdELFlBQU8sR0FBUCxPQUFPLENBQW1CO0FBQUMsUUFDM0IsWUFBTyxHQUFQLE9BQU8sQ0FBWTtBQUFDLFFBQ3BCLFNBQUksR0FBSixJQUFJLENBQVE7QUFBQyxRQUNiLGFBQVEsR0FBUixRQUFRLENBQVc7QUFBQyxRQVRyQixxQkFBZ0IsR0FBRyxLQUFLLENBQUMsQ0FBQyxtQkFBbUI7QUFDeEQ7QUFDMkIsUUFBZixtQkFBYyxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7QUFDaEQsSUFPTSxDQUFDO0FBQ1A7QUFDTztBQUNJO0FBQVEsSUFEakIsUUFBUTtBQUNWLFFBQUksSUFBSSxRQUFRLElBQUksUUFBUSxDQUFDLE1BQU0sRUFBRSxFQUFFLHFEQUFxRDtBQUM1RixZQUFNLElBQUksSUFBSSxDQUFDLGdCQUFnQixFQUFFO0FBQ2pDLGdCQUFRLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUN0QixhQUFPO0FBQUMsaUJBQUs7QUFDYixnQkFBUSxJQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFpQjtBQUFNO0FBR3pDO0FBRWUsZ0JBTHFCLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsRUFBQyxDQUFDO0FBQ3pELGFBQU87QUFDUCxTQUFLO0FBQ0wsSUFBRSxDQUFDO0FBQ0g7QUFDTztBQUEwQjtBQUFtQjtBQUFRLElBQTFELFdBQVcsQ0FBQyxPQUE4RDtBQUM1RTtBQUF5QixjQUFmLGFBQWEsR0FBaUIsT0FBTyxDQUFDLGlCQUFpQjtBQUNqRSxRQUNJLElBQUksYUFBYSxJQUFJLENBQUMsYUFBYSxDQUFDLGFBQWEsRUFBRSxFQUFFO0FBQ3pEO0FBQTZCLGtCQUFqQixlQUFlLEdBQXNCLGFBQWEsQ0FBQyxhQUFhO0FBQzVFO0FBQTZCLGtCQUFqQixjQUFjLEdBQXNCLGFBQWEsQ0FBQyxZQUFZO0FBQzFFLFlBQ00sTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxPQUFPO0FBQU07QUFDckI7QUFBMkI7QUFBZ0IsWUFEM0IsVUFBVSxDQUFDLEVBQUU7QUFDdkQsZ0JBQVEsSUFBSSxjQUFjLENBQUMsVUFBVSxDQUFDLEtBQUssZUFBZSxDQUFDLFVBQVUsQ0FBQyxFQUFFO0FBQ3hFLG9CQUFVLDhCQUE4QjtBQUN4QyxvQkFBVSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7QUFDN0UsaUJBQVM7QUFDVCxZQUFNLENBQUMsRUFBQyxDQUFDO0FBQ1QsU0FBSztBQUNMLElBQUUsQ0FBQztBQUNIO0FBQ087QUFDQztBQUFRLElBRGQsV0FBVztBQUNiLFFBQUksSUFBSSxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7QUFDL0IsWUFBTSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDdEMsU0FBSztBQUNMLElBQUUsQ0FBQztBQUNIO0FBQ087QUFDTDtBQUFtQjtBQUFRLElBRG5CLE1BQU07QUFDaEI7QUFBeUIsY0FBZixTQUFTLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsYUFBYTtBQUNoSixRQUNJLFVBQVU7QUFBTTtBQUNBO0FBQVksUUFEakIsR0FBRyxFQUFFO0FBQ3BCLFlBQU0sSUFBSSxDQUFDLGdCQUFnQixHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUN2RSxZQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0FBQ3RELFFBQUksQ0FBQyxHQUFFLENBQUMsQ0FBQyxDQUFDO0FBQ1YsSUFBRSxDQUFDO0FBQ0g7QUFDTztBQUFnQjtBQUFtQjtBQUN0QyxJQURNLFdBQVc7QUFBSyxRQUN0QixJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRTtBQUMxQixZQUFNLE9BQU8sSUFBSSxrQkFBa0IsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN4QyxTQUFLO0FBQUMsYUFBSyxJQUFJLElBQUksQ0FBQyxVQUFVLFlBQVksa0JBQWtCLEVBQUU7QUFDOUQsWUFBTSxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUM7QUFDN0IsU0FBSztBQUFDLGFBQUs7QUFDWCxZQUFNLE9BQU8sSUFBSSxrQkFBa0IsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO0FBQ3ZELFNBQUs7QUFDTCxJQUFFLENBQUM7QUFDSDtBQUNPO0FBQWdCO0FBQ1A7QUFBUSxJQUR0QixJQUFZLE9BQU87QUFDckIsUUFBSSx5QkFBWSxJQUFJLENBQUMsb0JBQW9CLEVBQUssSUFBSSxDQUFDLGdCQUFnQixFQUFHO0FBQ3RFLElBQUUsQ0FBQztBQUNIO0FBQ087QUFBZ0I7QUFDcEI7QUFBUSxJQURULElBQVksb0JBQW9CO0FBQ2xDLFFBQUkseUJBQVksQ0FBQyxJQUFJLENBQUMsWUFBWSxJQUFJLEVBQUUsQ0FBQyxFQUFLLENBQUMsSUFBSSxDQUFDLGlCQUFpQixJQUFJLEVBQUUsQ0FBQyxFQUFHO0FBQy9FLElBQUUsQ0FBQztBQUNIO0FBQ087QUFBZ0I7QUFBNEI7QUFDaEM7QUFBbUI7QUFBUSxJQURwQyxVQUFVLENBQUMsU0FBaUIsRUFBRSxHQUFHLE1BQWE7QUFDeEQsUUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUc7QUFBTTtBQUF1QjtBQUFZLFFBQXhDLEdBQUcsRUFBRTtBQUFHLFlBQ3BCLElBQUksSUFBSSxDQUFDLG9CQUFvQixJQUFJLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxTQUFTLENBQUMsRUFBRTtBQUM3RSxnQkFBUSxJQUFJLENBQUMsb0JBQW9CLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQztBQUN4RCxhQUFPO0FBQ1AsUUFBSSxDQUFDLEVBQUMsQ0FBQztBQUNQLElBQUUsQ0FBQztBQUNIO0FBQ087QUFBZ0I7QUFDVDtBQUFRLElBRHBCLElBQVksU0FBUztBQUN2QixRQUFJLE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxPQUFPLENBQUM7QUFDbkgsSUFBRSxDQUFDO0FBQ0g7QUFDTztBQUFnQjtBQUNkO0FBQXVCO0FBQW1CO0FBQVEsSUFEakQsS0FBSyxDQUFJLElBQU87QUFBSSxRQUMxQix5REFBeUQ7QUFDN0QsUUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDLHVCQUF1QixJQUFJO0FBQU07QUFHaEQ7QUFBdUI7QUFBWSxRQUhRLE9BQU8sQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUN4RSxJQUFFLENBQUM7QUFDSDtBQUNPO0FBQWdCO0FBQW1CO0FBQVEsSUFBaEQsSUFBWSxnQkFBZ0I7QUFBSyxRQUMvQix1RkFBdUY7QUFDM0YsUUFBSSxxREFBcUQ7QUFDekQsUUFBSSxPQUFPO0FBQ1gsWUFBTSxLQUFLO0FBQU87QUFDVDtBQUEyQjtBQUNwQyxZQUZhLENBQUMsS0FBb0IsRUFBRSxFQUFFO0FBQ3RDLGdCQUFRLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUTtBQUFRO0FBQ2hCO0FBQStCO0FBQ2pELGdCQUY2QixDQUFDLEtBQVksRUFBRSxFQUFFO0FBQ2pELG9CQUFVLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztBQUNwRSxvQkFBVSxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQztBQUMxQyxnQkFBUSxDQUFDLENBQUEsQ0FBQztBQUNWLGdCQUNRLElBQUksQ0FBQyxVQUFVLENBQUMsZUFBZSxFQUFFLEtBQUssQ0FBQyxDQUFDO0FBQ2hELFlBQU0sQ0FBQyxDQUFBO0FBQ1AsWUFBTSxRQUFRO0FBQU87QUFDWjtBQUEyQjtBQUU5QixZQUhVLENBQUMsS0FBb0IsRUFBRSxFQUFFO0FBQ3pDO0FBQWlDLHNCQUFuQixRQUFRLEdBQUcsSUFBSSxDQUFDLFdBQVcsRUFBRTtBQUMzQyxnQkFDUSxJQUFJLFFBQVEsQ0FBQyxRQUFRLEVBQUU7QUFDL0Isb0JBQVUsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFO0FBQzlCLHdCQUFZLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUc7QUFBTTtBQUU5RDtBQUNoQjtBQUE0Qix3QkFINkMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFDLENBQUMsQ0FBQztBQUN2Ryx3QkFDWSwwQ0FBMEM7QUFDdEQsd0JBQVkseUZBQXlGO0FBQ3JHLHdCQUFZLCtFQUErRTtBQUMzRix3QkFBWSw0RkFBNEY7QUFDeEcsd0JBQVkseUVBQXlFO0FBQ3JGLHdCQUFZLDhGQUE4RjtBQUMxRyx3QkFBWSwyRkFBMkY7QUFDdkcsd0JBQVksb0RBQW9EO0FBQ2hFLHdCQUFZLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUN6RSx3QkFBWSxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLFVBQVUsRUFBRSxLQUFLLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUN4Rix3QkFBWSxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLFVBQVUsRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDM0UscUJBQVc7QUFBQyx5QkFBSztBQUNqQix3QkFBWSxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7QUFDN0UscUJBQVc7QUFDWCxvQkFDVSxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7QUFDdkMsaUJBQVM7QUFDVCxnQkFDUSxJQUFJLENBQUMsVUFBVSxDQUFDLFVBQVUsRUFBRSxLQUFLLENBQUMsQ0FBQztBQUMzQyxZQUFNLENBQUMsQ0FBQTtBQUNQLFlBQU0sUUFBUTtBQUFPO0FBQ1o7QUFBMkI7QUFDN0IsWUFGUyxDQUFDLEtBQW9CLEVBQUUsRUFBRTtBQUN6QztBQUFpQyxzQkFBbkIsUUFBUSxHQUFHLElBQUksQ0FBQyxXQUFXLEVBQUU7QUFDM0M7QUFBaUMsc0JBQW5CLE9BQU8sR0FBRyxtQkFBbUIsQ0FBQyxLQUFLLENBQUM7QUFDbEQsZ0JBQ1EsUUFBUSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztBQUN0RixnQkFBUSxJQUFJLENBQUMsVUFBVSxDQUFDLFVBQVUsRUFBRSxLQUFLLENBQUMsQ0FBQztBQUMzQyxZQUFNLENBQUMsQ0FBQTtBQUNQLFNBQUssQ0FBQztBQUNOLElBQUUsQ0FBQztBQUNIOytDQTNKQyxTQUFTLFNBQUMsa0JBQ1QsUUFBUSxFQUFFLGNBQWMsZUFDekI7b2FBQ0k7QUFBQztBQUFtQjtBQUE2Qyw0Q0FxQmpFLFFBQVEsWUFBSSxNQUFNLFNBQUMsT0FBTztBQUFTLFlBeEMvQixpQkFBaUI7QUFBSSxZQU5WLFVBQVU7QUFBSSxZQUEyQixNQUFNO0FBQUksWUFBOEMsU0FBUztBQUFHO0FBQUc7QUFDOUgseUJBMEJILEtBQUs7QUFDTixrQ0FFQyxLQUFLO0FBQ04sZ0NBRUMsS0FBSztBQUNOLHNDQUVDLEtBQUs7QUFDTiwrQkFJQyxLQUFLO0FBQUssNkJBRVYsTUFBTTtBQUFJOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztvQkFBRTtBQUFDO0FBQWE7QUFFN0IsSUFsQkUseUNBQ29DO0FBQUM7QUFBcUIsSUFFMUQsa0RBQzRCO0FBQzlCO0FBRVMsSUFEUCxnREFDcUM7QUFDdkM7QUFFUyxJQURQLHNEQUMyQztBQUM3QztBQUNPO0FBQWlCO0FBRWxCO0FBQVEsSUFGWiwrQ0FBOEI7QUFDaEM7QUFDb0IsSUFBbEIsK0NBQWtDO0FBQUM7QUFFckMsSUFBRSw2Q0FBOEM7QUFDaEQ7QUFDTztBQUNFO0FBQWdCO0FBQVEsSUFBN0IsMkNBQW9FO0FBQUM7QUFDbEU7QUFBaUI7QUFDeEI7QUFBUSxJQURKLHNDQUFrQztBQUFDO0FBQ2hDO0FBQWlCO0FBQ2pCO0FBQVEsSUFEWCxzQ0FBMkI7QUFBQztBQUN6QjtBQUFpQjtBQUNWO0FBQVEsSUFEbEIsbUNBQW9CO0FBQUM7QUFDbEI7QUFBaUI7QUFDakI7QUFFRCxJQUhGLHVDQUEyQjtBQUFDO0FBQy9CO0FBQUk7QUFFRTtBQStIUCw0QkFPQztBQUNEO0FBQWE7QUFBcUIsSUFQaEMsaUNBQWlCO0FBQ25CO0FBQ0MsSUFEQyxpQ0FBaUI7QUFDbkI7QUFDQyxJQURDLDBDQUEyQjtBQUM3QjtBQUNDLElBREMsMENBQTJCO0FBQzdCO0FBQ0EsSUFERSw2QkFBa0I7QUFDcEI7QUFBcUIsSUFBbkIsOEJBQW1CO0FBQ3JCO0FBQ0E7QUFBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSwgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyLCBJbmplY3QsIElucHV0LCBOZ1pvbmUsIE9uQ2hhbmdlcywgT25EZXN0cm95LCBPbkluaXQsIE9wdGlvbmFsLCBPdXRwdXQsIFJlbmRlcmVyMiwgU2ltcGxlQ2hhbmdlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgU29ydGFibGUgZnJvbSAnc29ydGFibGVqcyc7XG5pbXBvcnQgeyBHTE9CQUxTIH0gZnJvbSAnLi9nbG9iYWxzJztcbmltcG9ydCB7IFNvcnRhYmxlanNCaW5kaW5nVGFyZ2V0IH0gZnJvbSAnLi9zb3J0YWJsZWpzLWJpbmRpbmctdGFyZ2V0JztcbmltcG9ydCB7IFNvcnRhYmxlanNCaW5kaW5ncyB9IGZyb20gJy4vc29ydGFibGVqcy1iaW5kaW5ncyc7XG5pbXBvcnQgeyBTb3J0YWJsZWpzT3B0aW9ucyB9IGZyb20gJy4vc29ydGFibGVqcy1vcHRpb25zJztcbmltcG9ydCB7IFNvcnRhYmxlanNTZXJ2aWNlIH0gZnJvbSAnLi9zb3J0YWJsZWpzLnNlcnZpY2UnO1xuXG5jb25zdCBnZXRJbmRleGVzRnJvbUV2ZW50ID0gKGV2ZW50OiBTb3J0YWJsZUV2ZW50KSA9PiB7XG4gIGlmIChldmVudC5oYXNPd25Qcm9wZXJ0eSgnbmV3RHJhZ2dhYmxlSW5kZXgnKSAmJiBldmVudC5oYXNPd25Qcm9wZXJ0eSgnb2xkRHJhZ2dhYmxlSW5kZXgnKSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgbmV3OiBldmVudC5uZXdEcmFnZ2FibGVJbmRleCxcbiAgICAgICAgb2xkOiBldmVudC5vbGREcmFnZ2FibGVJbmRleCxcbiAgICAgIH07XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG5ldzogZXZlbnQubmV3SW5kZXgsXG4gICAgICBvbGQ6IGV2ZW50Lm9sZEluZGV4LFxuICAgIH07XG4gIH1cbn07XG5cbkBEaXJlY3RpdmUoe1xuICBzZWxlY3RvcjogJ1tzb3J0YWJsZWpzXScsXG59KVxuZXhwb3J0IGNsYXNzIFNvcnRhYmxlanNEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcywgT25EZXN0cm95IHtcblxuICBASW5wdXQoKVxuICBzb3J0YWJsZWpzOiBTb3J0YWJsZWpzQmluZGluZ1RhcmdldDsgLy8gYXJyYXkgb3IgYSBGb3JtQXJyYXlcblxuICBASW5wdXQoKVxuICBzb3J0YWJsZWpzQ29udGFpbmVyOiBzdHJpbmc7XG5cbiAgQElucHV0KClcbiAgc29ydGFibGVqc09wdGlvbnM6IFNvcnRhYmxlanNPcHRpb25zO1xuXG4gIEBJbnB1dCgpXG4gIHNvcnRhYmxlanNDbG9uZUZ1bmN0aW9uOiA8VD4oaXRlbTogVCkgPT4gVDtcblxuICBwcml2YXRlIHNvcnRhYmxlSW5zdGFuY2U6IGFueTtcblxuICBASW5wdXQoKSBydW5JbnNpZGVBbmd1bGFyID0gZmFsc2U7IC8vIHRvIGJlIGRlcHJlY2F0ZWRcblxuICBAT3V0cHV0KCkgc29ydGFibGVqc0luaXQgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQE9wdGlvbmFsKCkgQEluamVjdChHTE9CQUxTKSBwcml2YXRlIGdsb2JhbENvbmZpZzogU29ydGFibGVqc09wdGlvbnMsXG4gICAgcHJpdmF0ZSBzZXJ2aWNlOiBTb3J0YWJsZWpzU2VydmljZSxcbiAgICBwcml2YXRlIGVsZW1lbnQ6IEVsZW1lbnRSZWYsXG4gICAgcHJpdmF0ZSB6b25lOiBOZ1pvbmUsXG4gICAgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyLFxuICApIHsgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIGlmIChTb3J0YWJsZSAmJiBTb3J0YWJsZS5jcmVhdGUpIHsgLy8gU29ydGFibGUgZG9lcyBub3QgZXhpc3QgaW4gYW5ndWxhciB1bml2ZXJzYWwgKFNTUilcbiAgICAgIGlmICh0aGlzLnJ1bkluc2lkZUFuZ3VsYXIpIHtcbiAgICAgICAgdGhpcy5jcmVhdGUoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB0aGlzLmNyZWF0ZSgpKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiB7IFtwcm9wIGluIGtleW9mIFNvcnRhYmxlanNEaXJlY3RpdmVdOiBTaW1wbGVDaGFuZ2UgfSkge1xuICAgIGNvbnN0IG9wdGlvbnNDaGFuZ2U6IFNpbXBsZUNoYW5nZSA9IGNoYW5nZXMuc29ydGFibGVqc09wdGlvbnM7XG5cbiAgICBpZiAob3B0aW9uc0NoYW5nZSAmJiAhb3B0aW9uc0NoYW5nZS5pc0ZpcnN0Q2hhbmdlKCkpIHtcbiAgICAgIGNvbnN0IHByZXZpb3VzT3B0aW9uczogU29ydGFibGVqc09wdGlvbnMgPSBvcHRpb25zQ2hhbmdlLnByZXZpb3VzVmFsdWU7XG4gICAgICBjb25zdCBjdXJyZW50T3B0aW9uczogU29ydGFibGVqc09wdGlvbnMgPSBvcHRpb25zQ2hhbmdlLmN1cnJlbnRWYWx1ZTtcblxuICAgICAgT2JqZWN0LmtleXMoY3VycmVudE9wdGlvbnMpLmZvckVhY2gob3B0aW9uTmFtZSA9PiB7XG4gICAgICAgIGlmIChjdXJyZW50T3B0aW9uc1tvcHRpb25OYW1lXSAhPT0gcHJldmlvdXNPcHRpb25zW29wdGlvbk5hbWVdKSB7XG4gICAgICAgICAgLy8gdXNlIGxvdy1sZXZlbCBvcHRpb24gc2V0dGVyXG4gICAgICAgICAgdGhpcy5zb3J0YWJsZUluc3RhbmNlLm9wdGlvbihvcHRpb25OYW1lLCB0aGlzLm9wdGlvbnNbb3B0aW9uTmFtZV0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICBpZiAodGhpcy5zb3J0YWJsZUluc3RhbmNlKSB7XG4gICAgICB0aGlzLnNvcnRhYmxlSW5zdGFuY2UuZGVzdHJveSgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlKCkge1xuICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMuc29ydGFibGVqc0NvbnRhaW5lciA/IHRoaXMuZWxlbWVudC5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IodGhpcy5zb3J0YWJsZWpzQ29udGFpbmVyKSA6IHRoaXMuZWxlbWVudC5uYXRpdmVFbGVtZW50O1xuXG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICB0aGlzLnNvcnRhYmxlSW5zdGFuY2UgPSBTb3J0YWJsZS5jcmVhdGUoY29udGFpbmVyLCB0aGlzLm9wdGlvbnMpO1xuICAgICAgdGhpcy5zb3J0YWJsZWpzSW5pdC5lbWl0KHRoaXMuc29ydGFibGVJbnN0YW5jZSk7XG4gICAgfSwgMCk7XG4gIH1cblxuICBwcml2YXRlIGdldEJpbmRpbmdzKCk6IFNvcnRhYmxlanNCaW5kaW5ncyB7XG4gICAgaWYgKCF0aGlzLnNvcnRhYmxlanMpIHtcbiAgICAgIHJldHVybiBuZXcgU29ydGFibGVqc0JpbmRpbmdzKFtdKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMuc29ydGFibGVqcyBpbnN0YW5jZW9mIFNvcnRhYmxlanNCaW5kaW5ncykge1xuICAgICAgcmV0dXJuIHRoaXMuc29ydGFibGVqcztcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG5ldyBTb3J0YWJsZWpzQmluZGluZ3MoW3RoaXMuc29ydGFibGVqc10pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0IG9wdGlvbnMoKSB7XG4gICAgcmV0dXJuIHsgLi4udGhpcy5vcHRpb25zV2l0aG91dEV2ZW50cywgLi4udGhpcy5vdmVycmlkZW5PcHRpb25zIH07XG4gIH1cblxuICBwcml2YXRlIGdldCBvcHRpb25zV2l0aG91dEV2ZW50cygpIHtcbiAgICByZXR1cm4geyAuLi4odGhpcy5nbG9iYWxDb25maWcgfHwge30pLCAuLi4odGhpcy5zb3J0YWJsZWpzT3B0aW9ucyB8fCB7fSkgfTtcbiAgfVxuXG4gIHByaXZhdGUgcHJveHlFdmVudChldmVudE5hbWU6IHN0cmluZywgLi4ucGFyYW1zOiBhbnlbXSkge1xuICAgIHRoaXMuem9uZS5ydW4oKCkgPT4geyAvLyByZS1lbnRlcmluZyB6b25lLCBzZWUgaHR0cHM6Ly9naXRodWIuY29tL1NvcnRhYmxlSlMvYW5ndWxhci1zb3J0YWJsZWpzL2lzc3Vlcy8xMTAjaXNzdWVjb21tZW50LTQwODg3NDYwMFxuICAgICAgaWYgKHRoaXMub3B0aW9uc1dpdGhvdXRFdmVudHMgJiYgdGhpcy5vcHRpb25zV2l0aG91dEV2ZW50c1tldmVudE5hbWVdKSB7XG4gICAgICAgIHRoaXMub3B0aW9uc1dpdGhvdXRFdmVudHNbZXZlbnROYW1lXSguLi5wYXJhbXMpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgaXNDbG9uaW5nKCkge1xuICAgIHJldHVybiB0aGlzLnNvcnRhYmxlSW5zdGFuY2Uub3B0aW9ucy5ncm91cC5jaGVja1B1bGwodGhpcy5zb3J0YWJsZUluc3RhbmNlLCB0aGlzLnNvcnRhYmxlSW5zdGFuY2UpID09PSAnY2xvbmUnO1xuICB9XG5cbiAgcHJpdmF0ZSBjbG9uZTxUPihpdGVtOiBUKTogVCB7XG4gICAgLy8gYnkgZGVmYXVsdCBwYXNzIHRoZSBpdGVtIHRocm91Z2gsIG5vIGNsb25pbmcgcGVyZm9ybWVkXG4gICAgcmV0dXJuICh0aGlzLnNvcnRhYmxlanNDbG9uZUZ1bmN0aW9uIHx8IChzdWJpdGVtID0+IHN1Yml0ZW0pKShpdGVtKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0IG92ZXJyaWRlbk9wdGlvbnMoKTogU29ydGFibGVqc09wdGlvbnMge1xuICAgIC8vIGFsd2F5cyBpbnRlcmNlcHQgc3RhbmRhcmQgZXZlbnRzIGJ1dCBhY3Qgb25seSBpbiBjYXNlIGl0ZW1zIGFyZSBzZXQgKGJpbmRpbmdFbmFibGVkKVxuICAgIC8vIGFsbG93cyB0byBmb3JnZXQgYWJvdXQgdHJhY2tpbmcgdGhpcy5pdGVtcyBjaGFuZ2VzXG4gICAgcmV0dXJuIHtcbiAgICAgIG9uQWRkOiAoZXZlbnQ6IFNvcnRhYmxlRXZlbnQpID0+IHtcbiAgICAgICAgdGhpcy5zZXJ2aWNlLnRyYW5zZmVyID0gKGl0ZW1zOiBhbnlbXSkgPT4ge1xuICAgICAgICAgIHRoaXMuZ2V0QmluZGluZ3MoKS5pbmplY3RJbnRvRXZlcnkoZXZlbnQubmV3SW5kZXgsIGl0ZW1zKTtcbiAgICAgICAgICB0aGlzLnByb3h5RXZlbnQoJ29uQWRkJywgZXZlbnQpO1xuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMucHJveHlFdmVudCgnb25BZGRPcmlnaW5hbCcsIGV2ZW50KTtcbiAgICAgIH0sXG4gICAgICBvblJlbW92ZTogKGV2ZW50OiBTb3J0YWJsZUV2ZW50KSA9PiB7XG4gICAgICAgIGNvbnN0IGJpbmRpbmdzID0gdGhpcy5nZXRCaW5kaW5ncygpO1xuXG4gICAgICAgIGlmIChiaW5kaW5ncy5wcm92aWRlZCkge1xuICAgICAgICAgIGlmICh0aGlzLmlzQ2xvbmluZykge1xuICAgICAgICAgICAgdGhpcy5zZXJ2aWNlLnRyYW5zZmVyKGJpbmRpbmdzLmdldEZyb21FdmVyeShldmVudC5vbGRJbmRleCkubWFwKGl0ZW0gPT4gdGhpcy5jbG9uZShpdGVtKSkpO1xuXG4gICAgICAgICAgICAvLyBncmVhdCB0aGFua3MgdG8gaHR0cHM6Ly9naXRodWIuY29tL3RhdXVcbiAgICAgICAgICAgIC8vIGV2ZW50Lml0ZW0gaXMgdGhlIG9yaWdpbmFsIGl0ZW0gZnJvbSB0aGUgc291cmNlIGxpc3Qgd2hpY2ggaXMgbW92ZWQgdG8gdGhlIHRhcmdldCBsaXN0XG4gICAgICAgICAgICAvLyBldmVudC5jbG9uZSBpcyBhIGNsb25lIG9mIHRoZSBvcmlnaW5hbCBpdGVtIGFuZCB3aWxsIGJlIGFkZGVkIHRvIHNvdXJjZSBsaXN0XG4gICAgICAgICAgICAvLyBJZiBiaW5kaW5ncyBhcmUgcHJvdmlkZWQsIGFkZGluZyB0aGUgaXRlbSBkb20gZWxlbWVudCB0byB0aGUgdGFyZ2V0IGxpc3QgY2F1c2VzIGFydGlmYWN0c1xuICAgICAgICAgICAgLy8gYXMgaXQgaW50ZXJmZXJlcyB3aXRoIHRoZSByZW5kZXJpbmcgcGVyZm9ybWVkIGJ5IHRoZSBhbmd1bGFyIHRlbXBsYXRlLlxuICAgICAgICAgICAgLy8gVGhlcmVmb3JlIHdlIHJlbW92ZSBpdCBpbW1lZGlhdGVseSBhbmQgYWxzbyBtb3ZlIHRoZSBvcmlnaW5hbCBpdGVtIGJhY2sgdG8gdGhlIHNvdXJjZSBsaXN0LlxuICAgICAgICAgICAgLy8gKGV2ZW50IGhhbmRsZXIgbWF5IGJlIGF0dGFjaGVkIHRvIHRoZSBvcmlnaW5hbCBpdGVtIGFuZCBub3QgaXRzIGNsb25lLCB0aGVyZWZvcmUga2VlcGluZ1xuICAgICAgICAgICAgLy8gdGhlIG9yaWdpbmFsIGRvbSBub2RlLCBjaXJjdW12ZW50cyBzaWRlIGVmZmVjdHMgKVxuICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDaGlsZChldmVudC5pdGVtLnBhcmVudE5vZGUsIGV2ZW50Lml0ZW0pO1xuICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5pbnNlcnRCZWZvcmUoZXZlbnQuY2xvbmUucGFyZW50Tm9kZSwgZXZlbnQuaXRlbSwgZXZlbnQuY2xvbmUpO1xuICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDaGlsZChldmVudC5jbG9uZS5wYXJlbnROb2RlLCBldmVudC5jbG9uZSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuc2VydmljZS50cmFuc2ZlcihiaW5kaW5ncy5leHRyYWN0RnJvbUV2ZXJ5KGV2ZW50Lm9sZEluZGV4KSk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgdGhpcy5zZXJ2aWNlLnRyYW5zZmVyID0gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMucHJveHlFdmVudCgnb25SZW1vdmUnLCBldmVudCk7XG4gICAgICB9LFxuICAgICAgb25VcGRhdGU6IChldmVudDogU29ydGFibGVFdmVudCkgPT4ge1xuICAgICAgICBjb25zdCBiaW5kaW5ncyA9IHRoaXMuZ2V0QmluZGluZ3MoKTtcbiAgICAgICAgY29uc3QgaW5kZXhlcyA9IGdldEluZGV4ZXNGcm9tRXZlbnQoZXZlbnQpO1xuXG4gICAgICAgIGJpbmRpbmdzLmluamVjdEludG9FdmVyeShpbmRleGVzLm5ldywgYmluZGluZ3MuZXh0cmFjdEZyb21FdmVyeShpbmRleGVzLm9sZCkpO1xuICAgICAgICB0aGlzLnByb3h5RXZlbnQoJ29uVXBkYXRlJywgZXZlbnQpO1xuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbn1cblxuaW50ZXJmYWNlIFNvcnRhYmxlRXZlbnQge1xuICBvbGRJbmRleDogbnVtYmVyO1xuICBuZXdJbmRleDogbnVtYmVyO1xuICBvbGREcmFnZ2FibGVJbmRleD86IG51bWJlcjtcbiAgbmV3RHJhZ2dhYmxlSW5kZXg/OiBudW1iZXI7XG4gIGl0ZW06IEhUTUxFbGVtZW50O1xuICBjbG9uZTogSFRNTEVsZW1lbnQ7XG59XG4iXX0=