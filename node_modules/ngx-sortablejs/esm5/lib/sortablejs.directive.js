/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Directive, ElementRef, EventEmitter, Inject, Input, NgZone, Optional, Output, Renderer2 } from '@angular/core';
import Sortable from 'sortablejs';
import { GLOBALS } from './globals';
import { SortablejsBindings } from './sortablejs-bindings';
import { SortablejsService } from './sortablejs.service';
/** @type {?} */
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './sortablejs.service';
var getIndexesFromEvent = (/**
 * @param {?} event
 * @return {?}
 */
function (event) {
    if (event.hasOwnProperty('newDraggableIndex') && event.hasOwnProperty('oldDraggableIndex')) {
        return {
            new: event.newDraggableIndex,
            old: event.oldDraggableIndex,
        };
    }
    else {
        return {
            new: event.newIndex,
            old: event.oldIndex,
        };
    }
});
var ɵ0 = getIndexesFromEvent;
var SortablejsDirective = /** @class */ (function () {
    function SortablejsDirective(globalConfig, service, element, zone, renderer) {
        this.globalConfig = globalConfig;
        this.service = service;
        this.element = element;
        this.zone = zone;
        this.renderer = renderer;
        this.runInsideAngular = false; // to be deprecated
        // to be deprecated
        this.sortablejsInit = new EventEmitter();
    }
    /**
     * @return {?}
     */
    SortablejsDirective.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        if (Sortable && Sortable.create) { // Sortable does not exist in angular universal (SSR)
            if (this.runInsideAngular) {
                this.create();
            }
            else {
                this.zone.runOutsideAngular((/**
                 * @return {?}
                 */
                function () { return _this.create(); }));
            }
        }
    };
    /**
     * @param {?} changes
     * @return {?}
     */
    SortablejsDirective.prototype.ngOnChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        var _this = this;
        /** @type {?} */
        var optionsChange = changes.sortablejsOptions;
        if (optionsChange && !optionsChange.isFirstChange()) {
            /** @type {?} */
            var previousOptions_1 = optionsChange.previousValue;
            /** @type {?} */
            var currentOptions_1 = optionsChange.currentValue;
            Object.keys(currentOptions_1).forEach((/**
             * @param {?} optionName
             * @return {?}
             */
            function (optionName) {
                if (currentOptions_1[optionName] !== previousOptions_1[optionName]) {
                    // use low-level option setter
                    _this.sortableInstance.option(optionName, _this.options[optionName]);
                }
            }));
        }
    };
    /**
     * @return {?}
     */
    SortablejsDirective.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        if (this.sortableInstance) {
            this.sortableInstance.destroy();
        }
    };
    /**
     * @private
     * @return {?}
     */
    SortablejsDirective.prototype.create = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var container = this.sortablejsContainer ? this.element.nativeElement.querySelector(this.sortablejsContainer) : this.element.nativeElement;
        setTimeout((/**
         * @return {?}
         */
        function () {
            _this.sortableInstance = Sortable.create(container, _this.options);
            _this.sortablejsInit.emit(_this.sortableInstance);
        }), 0);
    };
    /**
     * @private
     * @return {?}
     */
    SortablejsDirective.prototype.getBindings = /**
     * @private
     * @return {?}
     */
    function () {
        if (!this.sortablejs) {
            return new SortablejsBindings([]);
        }
        else if (this.sortablejs instanceof SortablejsBindings) {
            return this.sortablejs;
        }
        else {
            return new SortablejsBindings([this.sortablejs]);
        }
    };
    Object.defineProperty(SortablejsDirective.prototype, "options", {
        get: /**
         * @private
         * @return {?}
         */
        function () {
            return tslib_1.__assign({}, this.optionsWithoutEvents, this.overridenOptions);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SortablejsDirective.prototype, "optionsWithoutEvents", {
        get: /**
         * @private
         * @return {?}
         */
        function () {
            return tslib_1.__assign({}, (this.globalConfig || {}), (this.sortablejsOptions || {}));
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @private
     * @param {?} eventName
     * @param {...?} params
     * @return {?}
     */
    SortablejsDirective.prototype.proxyEvent = /**
     * @private
     * @param {?} eventName
     * @param {...?} params
     * @return {?}
     */
    function (eventName) {
        var _this = this;
        var params = [];
        for (var _i = 1; _i < arguments.length; _i++) {
            params[_i - 1] = arguments[_i];
        }
        this.zone.run((/**
         * @return {?}
         */
        function () {
            var _a;
            if (_this.optionsWithoutEvents && _this.optionsWithoutEvents[eventName]) {
                (_a = _this.optionsWithoutEvents)[eventName].apply(_a, tslib_1.__spread(params));
            }
        }));
    };
    Object.defineProperty(SortablejsDirective.prototype, "isCloning", {
        get: /**
         * @private
         * @return {?}
         */
        function () {
            return this.sortableInstance.options.group.checkPull(this.sortableInstance, this.sortableInstance) === 'clone';
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @private
     * @template T
     * @param {?} item
     * @return {?}
     */
    SortablejsDirective.prototype.clone = /**
     * @private
     * @template T
     * @param {?} item
     * @return {?}
     */
    function (item) {
        // by default pass the item through, no cloning performed
        return (this.sortablejsCloneFunction || ((/**
         * @param {?} subitem
         * @return {?}
         */
        function (subitem) { return subitem; })))(item);
    };
    Object.defineProperty(SortablejsDirective.prototype, "overridenOptions", {
        get: /**
         * @private
         * @return {?}
         */
        function () {
            var _this = this;
            // always intercept standard events but act only in case items are set (bindingEnabled)
            // allows to forget about tracking this.items changes
            return {
                onAdd: (/**
                 * @param {?} event
                 * @return {?}
                 */
                function (event) {
                    _this.service.transfer = (/**
                     * @param {?} items
                     * @return {?}
                     */
                    function (items) {
                        _this.getBindings().injectIntoEvery(event.newIndex, items);
                        _this.proxyEvent('onAdd', event);
                    });
                    _this.proxyEvent('onAddOriginal', event);
                }),
                onRemove: (/**
                 * @param {?} event
                 * @return {?}
                 */
                function (event) {
                    /** @type {?} */
                    var bindings = _this.getBindings();
                    if (bindings.provided) {
                        if (_this.isCloning) {
                            _this.service.transfer(bindings.getFromEvery(event.oldIndex).map((/**
                             * @param {?} item
                             * @return {?}
                             */
                            function (item) { return _this.clone(item); })));
                            // great thanks to https://github.com/tauu
                            // event.item is the original item from the source list which is moved to the target list
                            // event.clone is a clone of the original item and will be added to source list
                            // If bindings are provided, adding the item dom element to the target list causes artifacts
                            // as it interferes with the rendering performed by the angular template.
                            // Therefore we remove it immediately and also move the original item back to the source list.
                            // (event handler may be attached to the original item and not its clone, therefore keeping
                            // the original dom node, circumvents side effects )
                            _this.renderer.removeChild(event.item.parentNode, event.item);
                            _this.renderer.insertBefore(event.clone.parentNode, event.item, event.clone);
                            _this.renderer.removeChild(event.clone.parentNode, event.clone);
                        }
                        else {
                            _this.service.transfer(bindings.extractFromEvery(event.oldIndex));
                        }
                        _this.service.transfer = null;
                    }
                    _this.proxyEvent('onRemove', event);
                }),
                onUpdate: (/**
                 * @param {?} event
                 * @return {?}
                 */
                function (event) {
                    /** @type {?} */
                    var bindings = _this.getBindings();
                    /** @type {?} */
                    var indexes = getIndexesFromEvent(event);
                    bindings.injectIntoEvery(indexes.new, bindings.extractFromEvery(indexes.old));
                    _this.proxyEvent('onUpdate', event);
                }),
            };
        },
        enumerable: true,
        configurable: true
    });
    /** @nocollapse */
    SortablejsDirective.ctorParameters = function () { return [
        { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [GLOBALS,] }] },
        { type: SortablejsService },
        { type: ElementRef },
        { type: NgZone },
        { type: Renderer2 }
    ]; };
    SortablejsDirective.propDecorators = {
        sortablejs: [{ type: Input }],
        sortablejsContainer: [{ type: Input }],
        sortablejsOptions: [{ type: Input }],
        sortablejsCloneFunction: [{ type: Input }],
        runInsideAngular: [{ type: Input }],
        sortablejsInit: [{ type: Output }]
    };
SortablejsDirective.ɵfac = function SortablejsDirective_Factory(t) { return new (t || SortablejsDirective)(ɵngcc0.ɵɵdirectiveInject(GLOBALS, 8), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.SortablejsService), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ElementRef), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.NgZone), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.Renderer2)); };
SortablejsDirective.ɵdir = ɵngcc0.ɵɵdefineDirective({ type: SortablejsDirective, selectors: [["", "sortablejs", ""]], inputs: { runInsideAngular: "runInsideAngular", sortablejs: "sortablejs", sortablejsContainer: "sortablejsContainer", sortablejsOptions: "sortablejsOptions", sortablejsCloneFunction: "sortablejsCloneFunction" }, outputs: { sortablejsInit: "sortablejsInit" }, features: [ɵngcc0.ɵɵNgOnChangesFeature] });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(SortablejsDirective, [{
        type: Directive,
        args: [{
                selector: '[sortablejs]'
            }]
    }], function () { return [{ type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [GLOBALS]
            }] }, { type: ɵngcc1.SortablejsService }, { type: ɵngcc0.ElementRef }, { type: ɵngcc0.NgZone }, { type: ɵngcc0.Renderer2 }]; }, { runInsideAngular: [{
            type: Input
        }], sortablejsInit: [{
            type: Output
        }], sortablejs: [{
            type: Input
        }], sortablejsContainer: [{
            type: Input
        }], sortablejsOptions: [{
            type: Input
        }], sortablejsCloneFunction: [{
            type: Input
        }] }); })();
    return SortablejsDirective;
}());
export { SortablejsDirective };
if (false) {
    /** @type {?} */
    SortablejsDirective.prototype.sortablejs;
    /** @type {?} */
    SortablejsDirective.prototype.sortablejsContainer;
    /** @type {?} */
    SortablejsDirective.prototype.sortablejsOptions;
    /** @type {?} */
    SortablejsDirective.prototype.sortablejsCloneFunction;
    /**
     * @type {?}
     * @private
     */
    SortablejsDirective.prototype.sortableInstance;
    /** @type {?} */
    SortablejsDirective.prototype.runInsideAngular;
    /** @type {?} */
    SortablejsDirective.prototype.sortablejsInit;
    /**
     * @type {?}
     * @private
     */
    SortablejsDirective.prototype.globalConfig;
    /**
     * @type {?}
     * @private
     */
    SortablejsDirective.prototype.service;
    /**
     * @type {?}
     * @private
     */
    SortablejsDirective.prototype.element;
    /**
     * @type {?}
     * @private
     */
    SortablejsDirective.prototype.zone;
    /**
     * @type {?}
     * @private
     */
    SortablejsDirective.prototype.renderer;
}
/**
 * @record
 */
function SortableEvent() { }
if (false) {
    /** @type {?} */
    SortableEvent.prototype.oldIndex;
    /** @type {?} */
    SortableEvent.prototype.newIndex;
    /** @type {?|undefined} */
    SortableEvent.prototype.oldDraggableIndex;
    /** @type {?|undefined} */
    SortableEvent.prototype.newDraggableIndex;
    /** @type {?} */
    SortableEvent.prototype.item;
    /** @type {?} */
    SortableEvent.prototype.clone;
}
export { ɵ0 };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29ydGFibGVqcy5kaXJlY3RpdmUuanMiLCJzb3VyY2VzIjpbIm5neC1zb3J0YWJsZWpzL2xpYi9zb3J0YWJsZWpzLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBZ0MsUUFBUSxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQWdCLE1BQU0sZUFBZSxDQUFDO0FBQ3BLLE9BQU8sUUFBUSxNQUFNLFlBQVksQ0FBQztBQUNsQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRXBDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRTNELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3pEOzs7QUFDZ0IsSUFBVixtQkFBbUI7QUFBUTtBQUFvQjtBQUN6QztBQURnQixVQUFDLEtBQW9CO0FBQUksSUFDbkQsSUFBSSxLQUFLLENBQUMsY0FBYyxDQUFDLG1CQUFtQixDQUFDLElBQUksS0FBSyxDQUFDLGNBQWMsQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFO0FBQzlGLFFBQU0sT0FBTztBQUNiLFlBQVEsR0FBRyxFQUFFLEtBQUssQ0FBQyxpQkFBaUI7QUFDcEMsWUFBUSxHQUFHLEVBQUUsS0FBSyxDQUFDLGlCQUFpQjtBQUNwQyxTQUFPLENBQUM7QUFDUixLQUFHO0FBQUMsU0FBSztBQUNULFFBQUksT0FBTztBQUNYLFlBQU0sR0FBRyxFQUFFLEtBQUssQ0FBQyxRQUFRO0FBQ3pCLFlBQU0sR0FBRyxFQUFFLEtBQUssQ0FBQyxRQUFRO0FBQ3pCLFNBQUssQ0FBQztBQUNOLEtBQUc7QUFDSCxDQUFDLENBQUE7QUFDRDtBQUNBO0FBR1csSUFvQlQsNkJBQ3VDLFlBQStCLEVBQzVELE9BQTBCLEVBQzFCLE9BQW1CLEVBQ25CLElBQVksRUFDWixRQUFtQjtB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QUFpQjtBQUNqQjtBQUVELElBSEYsdUNBQTJCO0FBQUM7QUFDL0I7QUFBSTtBQUVFO0FBK0hQLDRCQU9DO0FBQ0Q7QUFBYTtBQUFxQixJQVBoQyxpQ0FBaUI7QUFDbkI7QUFDQyxJQURDLGlDQUFpQjtBQUNuQjtBQUNDLElBREMsMENBQTJCO0FBQzdCO0FBQ0MsSUFEQywwQ0FBMkI7QUFDN0I7QUFDQSxJQURFLDZCQUFrQjtBQUNwQjtBQUFxQixJQUFuQiw4QkFBbUI7QUFDckI7QUFDQTtBQUFlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBFbGVtZW50UmVmLCBFdmVudEVtaXR0ZXIsIEluamVjdCwgSW5wdXQsIE5nWm9uZSwgT25DaGFuZ2VzLCBPbkRlc3Ryb3ksIE9uSW5pdCwgT3B0aW9uYWwsIE91dHB1dCwgUmVuZGVyZXIyLCBTaW1wbGVDaGFuZ2UgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCBTb3J0YWJsZSBmcm9tICdzb3J0YWJsZWpzJztcbmltcG9ydCB7IEdMT0JBTFMgfSBmcm9tICcuL2dsb2JhbHMnO1xuaW1wb3J0IHsgU29ydGFibGVqc0JpbmRpbmdUYXJnZXQgfSBmcm9tICcuL3NvcnRhYmxlanMtYmluZGluZy10YXJnZXQnO1xuaW1wb3J0IHsgU29ydGFibGVqc0JpbmRpbmdzIH0gZnJvbSAnLi9zb3J0YWJsZWpzLWJpbmRpbmdzJztcbmltcG9ydCB7IFNvcnRhYmxlanNPcHRpb25zIH0gZnJvbSAnLi9zb3J0YWJsZWpzLW9wdGlvbnMnO1xuaW1wb3J0IHsgU29ydGFibGVqc1NlcnZpY2UgfSBmcm9tICcuL3NvcnRhYmxlanMuc2VydmljZSc7XG5cbmNvbnN0IGdldEluZGV4ZXNGcm9tRXZlbnQgPSAoZXZlbnQ6IFNvcnRhYmxlRXZlbnQpID0+IHtcbiAgaWYgKGV2ZW50Lmhhc093blByb3BlcnR5KCduZXdEcmFnZ2FibGVJbmRleCcpICYmIGV2ZW50Lmhhc093blByb3BlcnR5KCdvbGREcmFnZ2FibGVJbmRleCcpKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBuZXc6IGV2ZW50Lm5ld0RyYWdnYWJsZUluZGV4LFxuICAgICAgICBvbGQ6IGV2ZW50Lm9sZERyYWdnYWJsZUluZGV4LFxuICAgICAgfTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4ge1xuICAgICAgbmV3OiBldmVudC5uZXdJbmRleCxcbiAgICAgIG9sZDogZXZlbnQub2xkSW5kZXgsXG4gICAgfTtcbiAgfVxufTtcblxuQERpcmVjdGl2ZSh7XG4gIHNlbGVjdG9yOiAnW3NvcnRhYmxlanNdJyxcbn0pXG5leHBvcnQgY2xhc3MgU29ydGFibGVqc0RpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xuXG4gIEBJbnB1dCgpXG4gIHNvcnRhYmxlanM6IFNvcnRhYmxlanNCaW5kaW5nVGFyZ2V0OyAvLyBhcnJheSBvciBhIEZvcm1BcnJheVxuXG4gIEBJbnB1dCgpXG4gIHNvcnRhYmxlanNDb250YWluZXI6IHN0cmluZztcblxuICBASW5wdXQoKVxuICBzb3J0YWJsZWpzT3B0aW9uczogU29ydGFibGVqc09wdGlvbnM7XG5cbiAgQElucHV0KClcbiAgc29ydGFibGVqc0Nsb25lRnVuY3Rpb246IDxUPihpdGVtOiBUKSA9PiBUO1xuXG4gIHByaXZhdGUgc29ydGFibGVJbnN0YW5jZTogYW55O1xuXG4gIEBJbnB1dCgpIHJ1bkluc2lkZUFuZ3VsYXIgPSBmYWxzZTsgLy8gdG8gYmUgZGVwcmVjYXRlZFxuXG4gIEBPdXRwdXQoKSBzb3J0YWJsZWpzSW5pdCA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBAT3B0aW9uYWwoKSBASW5qZWN0KEdMT0JBTFMpIHByaXZhdGUgZ2xvYmFsQ29uZmlnOiBTb3J0YWJsZWpzT3B0aW9ucyxcbiAgICBwcml2YXRlIHNlcnZpY2U6IFNvcnRhYmxlanNTZXJ2aWNlLFxuICAgIHByaXZhdGUgZWxlbWVudDogRWxlbWVudFJlZixcbiAgICBwcml2YXRlIHpvbmU6IE5nWm9uZSxcbiAgICBwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIsXG4gICkgeyB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgaWYgKFNvcnRhYmxlICYmIFNvcnRhYmxlLmNyZWF0ZSkgeyAvLyBTb3J0YWJsZSBkb2VzIG5vdCBleGlzdCBpbiBhbmd1bGFyIHVuaXZlcnNhbCAoU1NSKVxuICAgICAgaWYgKHRoaXMucnVuSW5zaWRlQW5ndWxhcikge1xuICAgICAgICB0aGlzLmNyZWF0ZSgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy56b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHRoaXMuY3JlYXRlKCkpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IHsgW3Byb3AgaW4ga2V5b2YgU29ydGFibGVqc0RpcmVjdGl2ZV06IFNpbXBsZUNoYW5nZSB9KSB7XG4gICAgY29uc3Qgb3B0aW9uc0NoYW5nZTogU2ltcGxlQ2hhbmdlID0gY2hhbmdlcy5zb3J0YWJsZWpzT3B0aW9ucztcblxuICAgIGlmIChvcHRpb25zQ2hhbmdlICYmICFvcHRpb25zQ2hhbmdlLmlzRmlyc3RDaGFuZ2UoKSkge1xuICAgICAgY29uc3QgcHJldmlvdXNPcHRpb25zOiBTb3J0YWJsZWpzT3B0aW9ucyA9IG9wdGlvbnNDaGFuZ2UucHJldmlvdXNWYWx1ZTtcbiAgICAgIGNvbnN0IGN1cnJlbnRPcHRpb25zOiBTb3J0YWJsZWpzT3B0aW9ucyA9IG9wdGlvbnNDaGFuZ2UuY3VycmVudFZhbHVlO1xuXG4gICAgICBPYmplY3Qua2V5cyhjdXJyZW50T3B0aW9ucykuZm9yRWFjaChvcHRpb25OYW1lID0+IHtcbiAgICAgICAgaWYgKGN1cnJlbnRPcHRpb25zW29wdGlvbk5hbWVdICE9PSBwcmV2aW91c09wdGlvbnNbb3B0aW9uTmFtZV0pIHtcbiAgICAgICAgICAvLyB1c2UgbG93LWxldmVsIG9wdGlvbiBzZXR0ZXJcbiAgICAgICAgICB0aGlzLnNvcnRhYmxlSW5zdGFuY2Uub3B0aW9uKG9wdGlvbk5hbWUsIHRoaXMub3B0aW9uc1tvcHRpb25OYW1lXSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIGlmICh0aGlzLnNvcnRhYmxlSW5zdGFuY2UpIHtcbiAgICAgIHRoaXMuc29ydGFibGVJbnN0YW5jZS5kZXN0cm95KCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGUoKSB7XG4gICAgY29uc3QgY29udGFpbmVyID0gdGhpcy5zb3J0YWJsZWpzQ29udGFpbmVyID8gdGhpcy5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3Rvcih0aGlzLnNvcnRhYmxlanNDb250YWluZXIpIDogdGhpcy5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQ7XG5cbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIHRoaXMuc29ydGFibGVJbnN0YW5jZSA9IFNvcnRhYmxlLmNyZWF0ZShjb250YWluZXIsIHRoaXMub3B0aW9ucyk7XG4gICAgICB0aGlzLnNvcnRhYmxlanNJbml0LmVtaXQodGhpcy5zb3J0YWJsZUluc3RhbmNlKTtcbiAgICB9LCAwKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0QmluZGluZ3MoKTogU29ydGFibGVqc0JpbmRpbmdzIHtcbiAgICBpZiAoIXRoaXMuc29ydGFibGVqcykge1xuICAgICAgcmV0dXJuIG5ldyBTb3J0YWJsZWpzQmluZGluZ3MoW10pO1xuICAgIH0gZWxzZSBpZiAodGhpcy5zb3J0YWJsZWpzIGluc3RhbmNlb2YgU29ydGFibGVqc0JpbmRpbmdzKSB7XG4gICAgICByZXR1cm4gdGhpcy5zb3J0YWJsZWpzO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbmV3IFNvcnRhYmxlanNCaW5kaW5ncyhbdGhpcy5zb3J0YWJsZWpzXSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXQgb3B0aW9ucygpIHtcbiAgICByZXR1cm4geyAuLi50aGlzLm9wdGlvbnNXaXRob3V0RXZlbnRzLCAuLi50aGlzLm92ZXJyaWRlbk9wdGlvbnMgfTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0IG9wdGlvbnNXaXRob3V0RXZlbnRzKCkge1xuICAgIHJldHVybiB7IC4uLih0aGlzLmdsb2JhbENvbmZpZyB8fCB7fSksIC4uLih0aGlzLnNvcnRhYmxlanNPcHRpb25zIHx8IHt9KSB9O1xuICB9XG5cbiAgcHJpdmF0ZSBwcm94eUV2ZW50KGV2ZW50TmFtZTogc3RyaW5nLCAuLi5wYXJhbXM6IGFueVtdKSB7XG4gICAgdGhpcy56b25lLnJ1bigoKSA9PiB7IC8vIHJlLWVudGVyaW5nIHpvbmUsIHNlZSBodHRwczovL2dpdGh1Yi5jb20vU29ydGFibGVKUy9hbmd1bGFyLXNvcnRhYmxlanMvaXNzdWVzLzExMCNpc3N1ZWNvbW1lbnQtNDA4ODc0NjAwXG4gICAgICBpZiAodGhpcy5vcHRpb25zV2l0aG91dEV2ZW50cyAmJiB0aGlzLm9wdGlvbnNXaXRob3V0RXZlbnRzW2V2ZW50TmFtZV0pIHtcbiAgICAgICAgdGhpcy5vcHRpb25zV2l0aG91dEV2ZW50c1tldmVudE5hbWVdKC4uLnBhcmFtcyk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGdldCBpc0Nsb25pbmcoKSB7XG4gICAgcmV0dXJuIHRoaXMuc29ydGFibGVJbnN0YW5jZS5vcHRpb25zLmdyb3VwLmNoZWNrUHVsbCh0aGlzLnNvcnRhYmxlSW5zdGFuY2UsIHRoaXMuc29ydGFibGVJbnN0YW5jZSkgPT09ICdjbG9uZSc7XG4gIH1cblxuICBwcml2YXRlIGNsb25lPFQ+KGl0ZW06IFQpOiBUIHtcbiAgICAvLyBieSBkZWZhdWx0IHBhc3MgdGhlIGl0ZW0gdGhyb3VnaCwgbm8gY2xvbmluZyBwZXJmb3JtZWRcbiAgICByZXR1cm4gKHRoaXMuc29ydGFibGVqc0Nsb25lRnVuY3Rpb24gfHwgKHN1Yml0ZW0gPT4gc3ViaXRlbSkpKGl0ZW0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgb3ZlcnJpZGVuT3B0aW9ucygpOiBTb3J0YWJsZWpzT3B0aW9ucyB7XG4gICAgLy8gYWx3YXlzIGludGVyY2VwdCBzdGFuZGFyZCBldmVudHMgYnV0IGFjdCBvbmx5IGluIGNhc2UgaXRlbXMgYXJlIHNldCAoYmluZGluZ0VuYWJsZWQpXG4gICAgLy8gYWxsb3dzIHRvIGZvcmdldCBhYm91dCB0cmFja2luZyB0aGlzLml0ZW1zIGNoYW5nZXNcbiAgICByZXR1cm4ge1xuICAgICAgb25BZGQ6IChldmVudDogU29ydGFibGVFdmVudCkgPT4ge1xuICAgICAgICB0aGlzLnNlcnZpY2UudHJhbnNmZXIgPSAoaXRlbXM6IGFueVtdKSA9PiB7XG4gICAgICAgICAgdGhpcy5nZXRCaW5kaW5ncygpLmluamVjdEludG9FdmVyeShldmVudC5uZXdJbmRleCwgaXRlbXMpO1xuICAgICAgICAgIHRoaXMucHJveHlFdmVudCgnb25BZGQnLCBldmVudCk7XG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy5wcm94eUV2ZW50KCdvbkFkZE9yaWdpbmFsJywgZXZlbnQpO1xuICAgICAgfSxcbiAgICAgIG9uUmVtb3ZlOiAoZXZlbnQ6IFNvcnRhYmxlRXZlbnQpID0+IHtcbiAgICAgICAgY29uc3QgYmluZGluZ3MgPSB0aGlzLmdldEJpbmRpbmdzKCk7XG5cbiAgICAgICAgaWYgKGJpbmRpbmdzLnByb3ZpZGVkKSB7XG4gICAgICAgICAgaWYgKHRoaXMuaXNDbG9uaW5nKSB7XG4gICAgICAgICAgICB0aGlzLnNlcnZpY2UudHJhbnNmZXIoYmluZGluZ3MuZ2V0RnJvbUV2ZXJ5KGV2ZW50Lm9sZEluZGV4KS5tYXAoaXRlbSA9PiB0aGlzLmNsb25lKGl0ZW0pKSk7XG5cbiAgICAgICAgICAgIC8vIGdyZWF0IHRoYW5rcyB0byBodHRwczovL2dpdGh1Yi5jb20vdGF1dVxuICAgICAgICAgICAgLy8gZXZlbnQuaXRlbSBpcyB0aGUgb3JpZ2luYWwgaXRlbSBmcm9tIHRoZSBzb3VyY2UgbGlzdCB3aGljaCBpcyBtb3ZlZCB0byB0aGUgdGFyZ2V0IGxpc3RcbiAgICAgICAgICAgIC8vIGV2ZW50LmNsb25lIGlzIGEgY2xvbmUgb2YgdGhlIG9yaWdpbmFsIGl0ZW0gYW5kIHdpbGwgYmUgYWRkZWQgdG8gc291cmNlIGxpc3RcbiAgICAgICAgICAgIC8vIElmIGJpbmRpbmdzIGFyZSBwcm92aWRlZCwgYWRkaW5nIHRoZSBpdGVtIGRvbSBlbGVtZW50IHRvIHRoZSB0YXJnZXQgbGlzdCBjYXVzZXMgYXJ0aWZhY3RzXG4gICAgICAgICAgICAvLyBhcyBpdCBpbnRlcmZlcmVzIHdpdGggdGhlIHJlbmRlcmluZyBwZXJmb3JtZWQgYnkgdGhlIGFuZ3VsYXIgdGVtcGxhdGUuXG4gICAgICAgICAgICAvLyBUaGVyZWZvcmUgd2UgcmVtb3ZlIGl0IGltbWVkaWF0ZWx5IGFuZCBhbHNvIG1vdmUgdGhlIG9yaWdpbmFsIGl0ZW0gYmFjayB0byB0aGUgc291cmNlIGxpc3QuXG4gICAgICAgICAgICAvLyAoZXZlbnQgaGFuZGxlciBtYXkgYmUgYXR0YWNoZWQgdG8gdGhlIG9yaWdpbmFsIGl0ZW0gYW5kIG5vdCBpdHMgY2xvbmUsIHRoZXJlZm9yZSBrZWVwaW5nXG4gICAgICAgICAgICAvLyB0aGUgb3JpZ2luYWwgZG9tIG5vZGUsIGNpcmN1bXZlbnRzIHNpZGUgZWZmZWN0cyApXG4gICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNoaWxkKGV2ZW50Lml0ZW0ucGFyZW50Tm9kZSwgZXZlbnQuaXRlbSk7XG4gICAgICAgICAgICB0aGlzLnJlbmRlcmVyLmluc2VydEJlZm9yZShldmVudC5jbG9uZS5wYXJlbnROb2RlLCBldmVudC5pdGVtLCBldmVudC5jbG9uZSk7XG4gICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNoaWxkKGV2ZW50LmNsb25lLnBhcmVudE5vZGUsIGV2ZW50LmNsb25lKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5zZXJ2aWNlLnRyYW5zZmVyKGJpbmRpbmdzLmV4dHJhY3RGcm9tRXZlcnkoZXZlbnQub2xkSW5kZXgpKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICB0aGlzLnNlcnZpY2UudHJhbnNmZXIgPSBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5wcm94eUV2ZW50KCdvblJlbW92ZScsIGV2ZW50KTtcbiAgICAgIH0sXG4gICAgICBvblVwZGF0ZTogKGV2ZW50OiBTb3J0YWJsZUV2ZW50KSA9PiB7XG4gICAgICAgIGNvbnN0IGJpbmRpbmdzID0gdGhpcy5nZXRCaW5kaW5ncygpO1xuICAgICAgICBjb25zdCBpbmRleGVzID0gZ2V0SW5kZXhlc0Zyb21FdmVudChldmVudCk7XG5cbiAgICAgICAgYmluZGluZ3MuaW5qZWN0SW50b0V2ZXJ5KGluZGV4ZXMubmV3LCBiaW5kaW5ncy5leHRyYWN0RnJvbUV2ZXJ5KGluZGV4ZXMub2xkKSk7XG4gICAgICAgIHRoaXMucHJveHlFdmVudCgnb25VcGRhdGUnLCBldmVudCk7XG4gICAgICB9LFxuICAgIH07XG4gIH1cblxufVxuXG5pbnRlcmZhY2UgU29ydGFibGVFdmVudCB7XG4gIG9sZEluZGV4OiBudW1iZXI7XG4gIG5ld0luZGV4OiBudW1iZXI7XG4gIG9sZERyYWdnYWJsZUluZGV4PzogbnVtYmVyO1xuICBuZXdEcmFnZ2FibGVJbmRleD86IG51bWJlcjtcbiAgaXRlbTogSFRNTEVsZW1lbnQ7XG4gIGNsb25lOiBIVE1MRWxlbWVudDtcbn1cbiJdfQ==